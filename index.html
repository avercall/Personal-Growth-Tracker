<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Growth Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
apiKey: "AIzaSyD4IYJo_cNRILK3KmmDExpmuO7F4c_izN4",
authDomain: "growth-tracker-a367c.firebaseapp.com",
projectId: "growth-tracker-a367c",
storageBucket: "growth-tracker-a367c.firebasestorage.app",
messagingSenderId: "277469925642",
appId: "1:277469925642:web:f79c6f277931c969bfaaf3",
measurementId: "G-DPYPWBMHLB"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);

// --- Global state ---
let dailyRows={}, weeklyPoints=0, currentLevel=1, streak=0;
let jobMinutes=0, impactMinutes=0, jobInterval, impactInterval;
let tasks=[], habits=[];
let dailyChart=null, weeklyChart=null;

// --- Elements ---
const loginCard = document.getElementById("login-card");
const appDiv = document.getElementById("app");
const loginError = document.getElementById("loginError");

// --- Helpers ---
function getLocalDate(){
  const today = new Date();
  return today.getFullYear() + "-" +
         String(today.getMonth()+1).padStart(2,'0') + "-" +
         String(today.getDate()).padStart(2,'0');
}

function calculateScore(row){
  return (row.prayer?1:0)+(row.mindset?1:0)+(row.prioritize?1:0)+(row.visualize?1:0)+
         (row.exercise?3:0)+(row.tracking?3:0)-row.habitSlips+row.jobHours+row.impactHours*3;
}

// --- Auth state ---
onAuthStateChanged(auth, async user => {
  if(user){
    loginCard.style.display = "none"; 
    appDiv.style.display = "block";

    dailyRows={};
    const dailySnap = await getDocs(collection(db,"users",user.uid,"dailyRows"));
    dailySnap.forEach(docSnap => { dailyRows[docSnap.id] = docSnap.data(); });

    const taskSnap = await getDoc(doc(db,"users",user.uid,"meta","tasks"));
    tasks = taskSnap.exists() ? taskSnap.data().tasks || [] : [];
    renderTasks();

    const habitSnap = await getDoc(doc(db,"users",user.uid,"meta","habits"));
    habits = habitSnap.exists() ? habitSnap.data().habits || [] : [];
    renderHabits();

    const timerSnap = await getDoc(doc(db,"users",user.uid,"meta","timers"));
    if(timerSnap.exists()){
      jobMinutes = timerSnap.data().jobMinutes || 0;
      impactMinutes = timerSnap.data().impactMinutes || 0;
      document.getElementById("jobTime").innerText = Math.floor(jobMinutes/60)+"h";
      document.getElementById("impactTime").innerText = Math.floor(impactMinutes/60)+"h";
    }

    renderAllRows();
    renderCharts();

  } else {
    loginCard.style.display="block"; 
    appDiv.style.display="none";
  }
});

// --- Login / Signup ---
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(e){ loginError.innerText=`Login failed: ${e.message}`; }
});
document.getElementById("signupBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await createUserWithEmailAndPassword(auth,email,password); alert("Signup successful! You can now login."); }
  catch(e){ loginError.innerText=`Signup failed: ${e.message}`; }
});
document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

// --- Save functions ---
async function saveDailyRow(row){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"dailyRows",row.date),row); }
async function saveTasks(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","tasks"),{tasks}); }
async function saveHabits(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","habits"),{habits}); }
async function saveTimers(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","timers"),{jobMinutes,impactMinutes}); }

// --- Daily Tracker ---
document.getElementById("addDayBtn").addEventListener("click", addDay);
function addDay(){
  const localDate = getLocalDate();
  if(dailyRows[localDate]){
    alert("Today's row already exists");
    return;
  }
  const row = { 
    date: localDate, prayer:false, mindset:false, prioritize:false, visualize:false, 
    exercise:false, tracking:false, habitSlips:0, jobHours:0, impactHours:0 
  };
  dailyRows[localDate]=row;
  saveDailyRow(row);
  renderAllRows();
  renderCharts();
}

function renderRow(row){
  const tbody = document.getElementById("dailyBody");
  const tr = document.createElement("tr");
  tr.id = "row_" + row.date;
  tr.innerHTML = `
<td>${row.date}</td>
<td><input type="checkbox" ${row.prayer?'checked':''} onchange="toggleCheck('${row.date}','prayer')"></td>
<td><input type="checkbox" ${row.mindset?'checked':''} onchange="toggleCheck('${row.date}','mindset')"></td>
<td><input type="checkbox" ${row.prioritize?'checked':''} onchange="toggleCheck('${row.date}','prioritize')"></td>
<td><input type="checkbox" ${row.visualize?'checked':''} onchange="toggleCheck('${row.date}','visualize')"></td>
<td><input type="checkbox" ${row.exercise?'checked':''} onchange="toggleCheck('${row.date}','exercise')"></td>
<td><input type="checkbox" ${row.tracking?'checked':''} onchange="toggleCheck('${row.date}','tracking')"></td>
<td id="habitSlips_${row.date}">${row.habitSlips}</td>
<td id="jobHours_${row.date}">${row.jobHours}</td>
<td id="impactHours_${row.date}">${row.impactHours}</td>
<td id="dailyScore_${row.date}">${calculateScore(row)}</td>
`;
  tbody.appendChild(tr);
}

// Render last 7 rows with today highlight
function renderAllRows(){
  const tbody = document.getElementById("dailyBody");
  tbody.innerHTML="";
  const dates = Object.keys(dailyRows).sort((a,b)=>new Date(b)-new Date(a));
  const last7Dates = dates.slice(0,7).reverse();
  const today = getLocalDate();
  last7Dates.forEach(d => {
    renderRow(dailyRows[d]);
    if(d===today) document.getElementById("row_"+d).style.backgroundColor="#dff0d8";
  });
}

// Toggle checkbox with color and tracking
window.toggleCheck = function(date,field){
  const row = dailyRows[date];
  row[field] = !row[field];
  if(field!=="tracking") row.tracking=true;

  const tr = document.getElementById("row_"+date);
  const cellIndex = {prayer:1, mindset:2, prioritize:3, visualize:4, exercise:5, tracking:6}[field];
  const checkbox = tr.querySelectorAll("td")[cellIndex].querySelector("input");
  checkbox.checked = row[field];
  tr.querySelectorAll("td")[6].querySelector("input").checked = row.tracking;

  tr.querySelectorAll("td")[cellIndex].style.backgroundColor = row[field] ? "#d4edda" : "";

  updateScore(date);
  saveDailyRow(row);
  renderCharts();
};

// --- Scoring & Levels ---
function updateScore(date){
  const row = dailyRows[date];
  let score = calculateScore(row);
  document.getElementById("dailyScore_"+date).innerText = score;

  weeklyPoints=0;
  for(const d in dailyRows) weeklyPoints+=calculateScore(dailyRows[d]);
  document.getElementById("weeklyScore").innerText = "Weekly Score: "+weeklyPoints;

  let nextMin=0,nextMax=0;
  if(currentLevel===1){nextMin=112;nextMax=125;}
  if(currentLevel===2){nextMin=126;nextMax=140;}
  if(currentLevel===3){nextMin=141;nextMax=170;}
  if(weeklyPoints>=nextMin && weeklyPoints<=nextMax){ streak++; if(streak>=4){currentLevel++; streak=0;} }
  else{ streak=0; }
  document.getElementById("levelDisplay").innerText = "Level: "+currentLevel;
  document.getElementById("streakDisplay").innerText = "Progress Toward Next Level: "+streak+"/4 weeks";
}

// --- Timers ---
document.getElementById("startJobBtn").addEventListener("click", ()=>startTimer('job'));
document.getElementById("stopJobBtn").addEventListener("click", ()=>stopTimer('job'));
document.getElementById("startImpactBtn").addEventListener("click", ()=>startTimer('impact'));
document.getElementById("stopImpactBtn").addEventListener("click", ()=>stopTimer('impact'));

function startTimer(type){
  if(type==="job" && !jobInterval){ jobInterval=setInterval(()=>{jobMinutes++; document.getElementById("jobTime").innerText=Math.floor(jobMinutes/60)+"h"; },60000); }
  if(type==="impact" && !impactInterval){ impactInterval=setInterval(()=>{impactMinutes++; document.getElementById("impactTime").innerText=Math.floor(impactMinutes/60)+"h"; },60000); }
}
function stopTimer(type){
  if(type==="job"){ clearInterval(jobInterval); jobInterval=null; const lastDate=Object.keys(dailyRows).slice(-1)[0]; if(lastDate){ dailyRows[lastDate].jobHours=Math.floor(jobMinutes/60); updateScore(lastDate); saveDailyRow(dailyRows[lastDate]); renderCharts(); saveTimers(); } }
  if(type==="impact"){ clearInterval(impactInterval); impactInterval=null; const lastDate=Object.keys(dailyRows).slice(-1)[0]; if(lastDate){ dailyRows[lastDate].impactHours=Math.floor(impactMinutes/60); updateScore(lastDate); saveDailyRow(dailyRows[lastDate]); renderCharts(); saveTimers(); } }
}

// --- Tasks & Habits ---
const taskInput = document.getElementById("taskInput");
document.getElementById("addTaskBtn").addEventListener("click", ()=>{
  if(taskInput.value.trim()!==""){ tasks.push(taskInput.value.trim()); taskInput.value=""; renderTasks(); saveTasks(); }
});
document.getElementById("resetTasksBtn").addEventListener("click", ()=>{
  tasks=[]; renderTasks(); saveTasks();
});
function renderTasks(){
  const div = document.getElementById("taskList"); div.innerHTML="";
  tasks.forEach((t,i)=>{
    const p = document.createElement("p"); p.innerText=t; div.appendChild(p);
  });
}

const habitInput = document.getElementById("habitInput");
document.getElementById("addHabitBtn").addEventListener("click", ()=>{
  if(habitInput.value.trim()!==""){ habits.push({name:habitInput.value.trim(),daysSince:0}); habitInput.value=""; renderHabits(); saveHabits(); }
});
function renderHabits(){
  const div = document.getElementById("habitList"); div.innerHTML="";
  habits.forEach((h,i)=>{
    const d = document.createElement("div"); d.className="habit";
    d.innerHTML=`${h.name} - Days Since Last Slip: ${h.daysSince} <button onclick="habitSlip(${i})">Slip</button> <button onclick="deleteHabit(${i})">Delete</button>`;
    div.appendChild(d);
  });
}
window.habitSlip = function(i){
  habits[i].daysSince=0;
  const lastDate=Object.keys(dailyRows).slice(-1)[0];
  if(lastDate){ dailyRows[lastDate].habitSlips++; updateScore(lastDate); saveDailyRow(dailyRows[lastDate]); renderCharts(); }
  renderHabits(); saveHabits();
}
window.deleteHabit=function(i){ habits.splice(i,1); renderHabits(); saveHabits(); }

// --- Charts ---
function renderCharts(){
  const dates = Object.keys(dailyRows).sort((a,b)=>new Date(a)-new Date(b));
  const last7Dates = dates.slice(-7);
  const dailyScores = last7Dates.map(d=>calculateScore(dailyRows[d]));

  const dailyCtx = document.getElementById("dailyScoreChart").getContext("2d");
  if(dailyChart) dailyChart.destroy();
  dailyChart = new Chart(dailyCtx,{
    type:'line',
    data:{ labels:last7Dates, datasets:[{label:'Daily Score', data:dailyScores, borderColor:'blue', backgroundColor:'rgba(0,123,255,0.2)', tension:0.3, fill:true} ]},
    options:{ responsive:true, plugins:{legend:{display:true}} }
  });

  // --- Weekly chart: Sunday → Saturday ---
  let weeklyData=[], weekLabels=[];
  let allDates = Object.keys(dailyRows).map(d=>new Date(d)).sort((a,b)=>a-b);
  let weekStart=null, weekSum=0;
  allDates.forEach((dateObj,index)=>{
      const day = dateObj.getDay();
      if(weekStart===null) weekStart=new Date(dateObj);
      const dateStr = dateObj.toISOString().split('T')[0];
      weekSum += calculateScore(dailyRows[dateStr]);
      if(day===6 || index===allDates.length-1){
          const weekEnd=new Date(dateObj);
          weeklyData.push(weekSum);
          weekLabels.push(`${weekStart.toISOString().split('T')[0]} → ${weekEnd.toISOString().split('T')[0]}`);
          weekSum=0;
          weekStart=null;
      }
  });

  const weeklyCtx=document.getElementById("weeklyBarChart").getContext("2d");
  if(weeklyChart) weeklyChart.destroy();
  weeklyChart = new Chart(weeklyCtx,{
    type:'bar',
    data:{ labels:weekLabels, datasets:[{label:'Weekly Score', data:weeklyData, backgroundColor:'rgba(40,167,69,0.7)', borderRadius:4} ]},
    options:{ responsive:true, plugins:{legend:{display:true}} }
  });
}
</script>

<style>
body { font-family: Arial, sans-serif; text-align: center; background: #f7f9fc; margin:0; padding:0; }
.card { background:white; padding:20px; margin:15px auto; width:90%; max-width:1000px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
tr:nth-child(even) { background: #f9f9f9; }
tr:hover { background: #eef; }
input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
button { padding: 5px 10px; border:none; border-radius:6px; background:#007bff; color:white; cursor:pointer; margin:2px; }
button:hover { transform: scale(1.05); }
.header-row { display:flex; justify-content: space-between; align-items: center; }
.header-row h2 { margin:0; }
.header-row button { margin:0; background:#dc3545; }
.habit { margin-bottom:5px; }
</style>
</head>

<body>

<div id="login-card" class="card">
<h2>Login / Signup</h2>
<p id="loginError" style="color:red;"></p>
<input id="email" type="email" placeholder="Email"><br>
<input id="password" type="password" placeholder="Password"><br>
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
</div>

<div id="app" style="display:none;">

<div class="card">
  <div class="header-row">
    <h2>Daily Tracker</h2>
    <button id="logoutBtn">Logout</button>
  </div>
  <button id="addDayBtn">Add Today</button>
  <table>
    <thead>
      <tr>
        <th>Date</th><th>Prayer</th><th>Mindset</th><th>Prioritize</th><th>Visualize</th><th>Exercise</th><th>Tracking</th><th>Habit Slips</th><th>Job Hours</th><th>Impact Hours</th><th>Daily Score</th>
      </tr>
    </thead>
    <tbody id="dailyBody"></tbody>
  </table>
  <p id="weeklyScore">Weekly Score: 0</p>
  <p id="levelDisplay">Level: 1</p>
  <p id="streakDisplay">Progress Toward Next Level: 0/4 weeks</p>
</div>

<div class="card">
<h2>Prioritization Tasks</h2>
<input type="text" id="taskInput" placeholder="Task">
<button id="addTaskBtn">Add Task</button>
<button id="resetTasksBtn">Reset</button>
<div id="taskList"></div>
</div>

<div class="card">
<h2>Habit Breaking</h2>
<input type="text" id="habitInput" placeholder="Habit">
<button id="addHabitBtn">Add Habit</button>
<div id="habitList"></div>
</div>

<div class="card">
<h2>Timers</h2>
<p>Job Hours: <span id="jobTime">0h</span> <button id="startJobBtn">Start</button> <button id="stopJobBtn">Stop</button></p>
<p>Impact Hours: <span id="impactTime">0h</span> <button id="startImpactBtn">Start</button> <button id="stopImpactBtn">Stop</button></p>
</div>

<div class="card">
<h2>Charts</h2>
<canvas id="dailyScoreChart"></canvas>
<canvas id="weeklyBarChart"></canvas>
</div>

</div>
</body>
</html>
