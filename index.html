<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Growth Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyD4IYJo_cNRILK3KmmDExpmuO7F4c_izN4",
  authDomain: "growth-tracker-a367c.firebaseapp.com",
  projectId: "growth-tracker-a367c",
  storageBucket: "growth-tracker-a367c.firebasestorage.app",
  messagingSenderId: "277469925642",
  appId: "1:277469925642:web:f79c6f277931c969bfaaf3",
  measurementId: "G-DPYPWBMHLB"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);

// --- Global state ---
let dailyRows={}, weeklyPoints=0;
let tasks=[], habits=[];
let timerState = {
  job: { startTime: null, accumulatedSeconds: 0, interval: null },
  impact: { startTime: null, accumulatedSeconds: 0, interval: null }
};
let dailyChart=null, weeklyChart=null, monthlyChart=null, pieChart=null;

// --- Level/Streak ---
const LEVEL_RANGES = [
  {level: 1, min: 0, max: 110},
  {level: 2, min: 112, max: 125},
  {level: 3, min: 126, max: 140},
  {level: 4, min: 141, max: 170}
];
let level = 1, weeklyStreak = 0;

// --- Elements ---
const loginCard = document.getElementById("login-card");
const appDiv = document.getElementById("app");
const loginError = document.getElementById("loginError");

// --- Helpers ---
function getLocalDate(){
  const today = new Date();
  return today.getFullYear() + "-" + String(today.getMonth()+1).padStart(2,'0') + "-" + String(today.getDate()).padStart(2,'0');
}
function calculateScore(row){
  return (row.prayer?1:0)+(row.mindset?1:0)+(row.prioritize?1:0)+(row.visualize?1:0)+
         (row.exercise?3:0)+(row.tracking?3:0)-row.habitSlips+row.jobHours+row.impactHours*3;
}

// --- Level/Streak Helpers ---
async function saveLevelStreak(){
  if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","levelStreak"),{level,weeklyStreak});
}
async function loadLevelStreak(){
  if(!auth.currentUser) return;
  const snap = await getDoc(doc(db,"users",auth.currentUser.uid,"meta","levelStreak"));
  if(snap.exists()){
    level = snap.data().level || 1;
    weeklyStreak = snap.data().weeklyStreak || 0;
  }
  updateLevelUI();
}
function updateLevelUI(){
  if(!document.getElementById("levelInfo")){
    const p = document.createElement("p"); p.id="levelInfo";
    p.style.fontWeight="bold"; p.style.fontSize="16px";
    document.querySelector(".card").appendChild(p);
  }
  document.getElementById("levelInfo").innerText = `Level: ${level} | Weekly Streak: ${weeklyStreak}`;
}
function getWeekNumber(d){
  const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const dayNum = date.getDay() || 7;
  date.setDate(date.getDate() + 4 - dayNum);
  const yearStart = new Date(date.getFullYear(),0,1);
  return Math.ceil((((date - yearStart)/86400000) + 1)/7) + "-" + date.getFullYear();
}

// --- Auth state ---
onAuthStateChanged(auth, async user => {
  if(user){
    loginCard.style.display = "none"; 
    appDiv.style.display = "block";
    await loadLevelStreak();
    await loadUserData(user.uid);
  } else {
    loginCard.style.display="block"; 
    appDiv.style.display="none";
  }
});

// --- Login / Signup ---
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(e){ loginError.innerText=`Login failed: ${e.message}`; }
});
document.getElementById("signupBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await createUserWithEmailAndPassword(auth,email,password); alert("Signup successful! You can now login."); }
  catch(e){ loginError.innerText=`Signup failed: ${e.message}`; }
});
document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

// --- Save functions ---
async function saveDailyRow(row){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"dailyRows",row.date),row); }
async function saveTasks(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","tasks"),{tasks}); }
async function saveHabits(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","habits"),{habits}); }
async function saveTimers(){
  if(!auth.currentUser) return;
  const jobCopy = {...timerState.job};
  const impactCopy = {...timerState.impact};
  if(jobCopy.startTime) jobCopy.startTime = new Date(jobCopy.startTime).getTime();
  if(impactCopy.startTime) impactCopy.startTime = new Date(impactCopy.startTime).getTime();
  await setDoc(doc(db,"users",auth.currentUser.uid,"meta","timers"),{job:jobCopy,impact:impactCopy});
}

// --- Load user data ---
async function loadUserData(uid){
  dailyRows={}; tasks=[]; habits=[];

  const dailySnap = await getDocs(collection(db,"users",uid,"dailyRows"));
  dailySnap.forEach(docSnap => { dailyRows[docSnap.id] = docSnap.data(); });

  const taskSnap = await getDoc(doc(db,"users",uid,"meta","tasks"));
  tasks = taskSnap.exists() ? taskSnap.data().tasks || [] : [];
  renderTasks();

  const habitSnap = await getDoc(doc(db,"users",uid,"meta","habits"));
  habits = habitSnap.exists() ? habitSnap.data().habits || [] : [];
  renderHabits();

  const timerSnap = await getDoc(doc(db,"users",uid,"meta","timers"));
  if(timerSnap.exists()){
    const data = timerSnap.data();
    if(data.job) timerState.job = data.job;
    if(data.impact) timerState.impact = data.impact;
    ['job','impact'].forEach(type=>{
      if(timerState[type].startTime){
        timerState[type].startTime = new Date(timerState[type].startTime).getTime();
        timerState[type].interval = setInterval(()=>updateTimersUI(type),1000);
      }
      updateTimersUI(type);
    });
  }
  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}

// --- Weekly score with level/streak ---
function updateWeeklyScore(){
  weeklyPoints = 0;
  for (const d in dailyRows) weeklyPoints += calculateScore(dailyRows[d]);
  document.getElementById("weeklyScore").innerText = "Weekly Score: " + weeklyPoints;

  const today = new Date();
  const currentWeek = getWeekNumber(today);
  const lastWeekKey = localStorage.getItem("lastWeekKey") || null;

  if(currentWeek !== lastWeekKey){
    const nextLevel = LEVEL_RANGES.find(l => l.level === level + 1);

    if(nextLevel && weeklyPoints >= nextLevel.min && weeklyPoints <= nextLevel.max){
      weeklyStreak++;
      if(weeklyStreak >= 4){
        level++;
        weeklyStreak = 0;
        alert(`ðŸŽ‰ Congratulations! You've leveled up to Level ${level}!`);
      }
    } else {
      weeklyStreak = 0;
    }

    localStorage.setItem("lastWeekKey", currentWeek);
    saveLevelStreak();
    updateLevelUI();
  }
}

// --- Rest of your Daily Tracker, Tasks, Habits, Timers, Charts code remains exactly the same ---
</script>

<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f2f2f2;}
.card{background:white;padding:20px;margin:15px auto;width:90%;max-width:1000px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
tr:nth-child(even){background:#f9f9f9;}
tr:hover{background:#eef;}
input[type="checkbox"]{transform:scale(1.2);cursor:pointer;}
button{padding:5px 10px;border:none;border-radius:6px;background:#007bff;color:white;cursor:pointer;margin:2px;}
button:hover{transform:scale(1.05);}
.header-row{display:flex;justify-content: space-between;align-items:center;}
.header-row h2{margin:0;text-align:center;width:100%;}
.header-row button{margin:0;background:#dc3545;}
.habit{margin-bottom:5px;}
#login-card{max-width:400px;margin-top:50px;text-align:center;}
#login-card input{margin:5px auto;display:block;width:80%;}
#taskInput,#habitInput{text-align:center;}
#taskList,#habitList{text-align:center;}
#jobTime,#impactTime{text-align:center;}
</style>
</head>
<body>

<div id="login-card" class="card">
<h2>Login / Signup</h2>
<p id="loginError" style="color:red;"></p>
<input id="email" type="email" placeholder="Email"><br>
<input id="password" type="password" placeholder="Password"><br>
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
</div>

<div id="app" style="display:none;">

<div class="card">
  <div class="header-row">
    <h2>Daily Tracker</h2>
    <button id="logoutBtn">Logout</button>
  </div>
  <button id="addDayBtn">Add Today</button>
  <table>
    <thead>
      <tr>
        <th>Date</th><th>Prayer</th><th>Mindset</th><th>Prioritize</th><th>Visualize</th><th>Exercise</th><th>Tracking</th><th>Habit Slips</th><th>Job Hours</th><th>Impact Hours</th><th>Score</th>
      </tr>
    </thead>
    <tbody id="dailyBody"></tbody>
  </table>
  <p id="weeklyScore">Weekly Score: 0</p>
</div>

<div class="card"><h2>Tasks</h2><input id="taskInput" placeholder="New Task"><button id="addTaskBtn">Add Task</button><button id="resetTasksBtn">Reset</button><div id="taskList"></div></div>

<div class="card"><h2>Habits</h2><input id="habitInput" placeholder="New Habit"><button id="addHabitBtn">Add Habit</button><div id="habitList"></div></div>

<div class="card"><h2>Timers</h2>
  <button id="startJobBtn">Start Job Hours</button>
  <button id="stopJobBtn">Stop Job Hours</button>
  <p id="jobTime">0h 0m 0s</p>
  <button id="startImpactBtn">Start Impact Hours</button>
  <button id="stopImpactBtn">Stop Impact Hours</button>
  <p id="impactTime">0h 0m 0s</p>
</div>

<div class="card"><h2>Charts</h2>
  <canvas id="dailyScoreChart"></canvas>
  <canvas id="weeklyBarChart"></canvas>
  <canvas id="monthlyLineChart"></canvas>
  <canvas id="pieChart"></canvas>
</div>

</div>
</body>
</html>
