<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Growth Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyD4IYJo_cNRILK3KmmDExpmuO7F4c_izN4",
  authDomain: "growth-tracker-a367c.firebaseapp.com",
  projectId: "growth-tracker-a367c",
  storageBucket: "growth-tracker-a367c.firebasestorage.app",
  messagingSenderId: "277469925642",
  appId: "1:277469925642:web:f79c6f277931c969bfaaf3",
  measurementId: "G-DPYPWBMHLB"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);

// --- Global state ---
let dailyRows={}, weeklyPoints=0;
let jobSeconds=0, impactSeconds=0, jobInterval=null, impactInterval=null;
let tasks=[], habits=[];
let dailyChart=null, weeklyChart=null, monthlyChart=null, pieChart=null;

// --- Elements ---
const loginCard = document.getElementById("login-card");
const appDiv = document.getElementById("app");
const loginError = document.getElementById("loginError");

// --- Helpers ---
function getLocalDate(){
  const today = new Date();
  return today.getFullYear() + "-" + String(today.getMonth()+1).padStart(2,'0') + "-" + String(today.getDate()).padStart(2,'0');
}

function calculateScore(row){
  return (row.prayer?1:0)+(row.mindset?1:0)+(row.prioritize?1:0)+(row.visualize?1:0)+
         (row.exercise?3:0)+(row.tracking?3:0)-row.habitSlips+row.jobHours+row.impactHours*3;
}

// --- Auth state ---
onAuthStateChanged(auth, async user => {
  if(user){
    loginCard.style.display = "none"; 
    appDiv.style.display = "block";
    await loadUserData(user.uid);
  } else {
    loginCard.style.display="block"; 
    appDiv.style.display="none";
  }
});

// --- Login / Signup ---
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(e){ loginError.innerText=`Login failed: ${e.message}`; }
});
document.getElementById("signupBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await createUserWithEmailAndPassword(auth,email,password); alert("Signup successful! You can now login."); }
  catch(e){ loginError.innerText=`Signup failed: ${e.message}`; }
});
document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

// --- Save functions ---
async function saveDailyRow(row){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"dailyRows",row.date),row); }
async function saveTasks(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","tasks"),{tasks}); }
async function saveHabits(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","habits"),{habits}); }
async function saveTimers(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","timers"),{jobSeconds,impactSeconds}); }

// --- Load user data ---
async function loadUserData(uid){
  dailyRows={}; tasks=[]; habits=[]; jobSeconds=0; impactSeconds=0;

  const dailySnap = await getDocs(collection(db,"users",uid,"dailyRows"));
  dailySnap.forEach(docSnap => { dailyRows[docSnap.id] = docSnap.data(); });

  const taskSnap = await getDoc(doc(db,"users",uid,"meta","tasks"));
  tasks = taskSnap.exists() ? taskSnap.data().tasks || [] : [];
  renderTasks();

  const habitSnap = await getDoc(doc(db,"users",uid,"meta","habits"));
  habits = habitSnap.exists() ? habitSnap.data().habits || [] : [];
  renderHabits();

  const timerSnap = await getDoc(doc(db,"users",uid,"meta","timers"));
  if(timerSnap.exists()){
    jobSeconds = timerSnap.data().jobSeconds || 0;
    impactSeconds = timerSnap.data().impactSeconds || 0;
  }
  updateTimersUI();
  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}

// --- Weekly score helper ---
function updateWeeklyScore(){
  weeklyPoints = 0;
  for (const d in dailyRows) weeklyPoints += calculateScore(dailyRows[d]);
  document.getElementById("weeklyScore").innerText = "Weekly Score: " + weeklyPoints;
}

// --- Daily Tracker ---
document.getElementById("addDayBtn").addEventListener("click", addDay);
function addDay(){
  const localDate = getLocalDate();
  if(dailyRows[localDate]){ alert("Today's row already exists"); return; }

  tasks = []; renderTasks(); saveTasks();

  const row = { 
    date: localDate, prayer:false, mindset:false, prioritize:false, visualize:false, 
    exercise:false, tracking:false, habitSlips:0, jobHours:0, impactHours:0 
  };
  dailyRows[localDate]=row;
  saveDailyRow(row);
  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}

function renderRow(row){
  const tbody = document.getElementById("dailyBody");
  const tr = document.createElement("tr");
  tr.id = "row_" + row.date;

  const score = calculateScore(row);
  tr.style.backgroundColor = score>=15?"#d4edda":(score>=10?"#fff3cd":"#f8d7da");

  tr.innerHTML = `
<td>${row.date}</td>
<td><input type="checkbox" ${row.prayer?'checked':''} onchange="toggleCheck('${row.date}','prayer')"></td>
<td><input type="checkbox" ${row.mindset?'checked':''} onchange="toggleCheck('${row.date}','mindset')"></td>
<td><input type="checkbox" ${row.prioritize?'checked':''} onchange="toggleCheck('${row.date}','prioritize')"></td>
<td><input type="checkbox" ${row.visualize?'checked':''} onchange="toggleCheck('${row.date}','visualize')"></td>
<td><input type="checkbox" ${row.exercise?'checked':''} onchange="toggleCheck('${row.date}','exercise')"></td>
<td><input type="checkbox" ${row.tracking?'checked':''} onchange="toggleCheck('${row.date}','tracking')"></td>
<td id="habitSlips_${row.date}">${row.habitSlips}</td>
<td id="jobHours_${row.date}">${row.jobHours}</td>
<td id="impactHours_${row.date}">${row.impactHours}</td>
<td id="dailyScore_${row.date}">${score}</td>
`;
  tbody.appendChild(tr);
}

function renderAllRows(){
  const tbody = document.getElementById("dailyBody"); tbody.innerHTML="";
  const dates = Object.keys(dailyRows).sort((a,b)=>new Date(a)-new Date(b));
  const last7 = dates.slice(-7);
  const today = getLocalDate();
  last7.forEach(d=>{ renderRow(dailyRows[d]); if(d===today) document.getElementById("row_"+d).style.fontWeight="bold"; });
}

// Toggle checkboxes
window.toggleCheck = function(date,field){
  const row = dailyRows[date];
  row[field]=!row[field];
  if(field!=="tracking") row.tracking=true;
  saveDailyRow(row);
  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}

// --- Tasks ---
document.getElementById("addTaskBtn").addEventListener("click", ()=>{
  const val = document.getElementById("taskInput").value.trim();
  if(val && tasks.length<3){ tasks.push({name:val,completed:false}); renderTasks(); saveTasks(); document.getElementById("taskInput").value=""; }
});
document.getElementById("resetTasksBtn").addEventListener("click", ()=>{
  tasks=[]; renderTasks(); saveTasks();
});
function renderTasks(){
  const div = document.getElementById("taskList"); div.innerHTML="";
  tasks.forEach((t,i)=>{
    const p=document.createElement("p");
    p.innerHTML=`<input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask(${i})"> ${t.name}`;
    div.appendChild(p);
  });
}
window.toggleTask=function(i){ tasks[i].completed=!tasks[i].completed; renderTasks(); saveTasks() }

// --- Habits ---
document.getElementById("addHabitBtn").addEventListener("click", ()=>{
  const val = document.getElementById("habitInput").value.trim();
  if(val){ habits.push({name:val,daysSinceLastSlip:0}); renderHabits(); saveHabits(); document.getElementById("habitInput").value=""; }
});
function renderHabits(){
  const div = document.getElementById("habitList"); div.innerHTML="";
  habits.forEach((h,i)=>{
    const p=document.createElement("p");
    p.className="habit";
    p.innerHTML=`${h.name} - ${h.daysSinceLastSlip} days <button onclick="habitSlip(${i})">Slip</button> <button onclick="deleteHabit(${i})">Delete</button>`;
    div.appendChild(p);
  });
}
window.habitSlip=function(i){
  habits[i].daysSinceLastSlip=0;
  const today = getLocalDate();
  if(dailyRows[today]) dailyRows[today].habitSlips++;
  saveHabits(); saveDailyRow(dailyRows[today]); 
  renderAllRows(); renderHabits(); updateWeeklyScore();
}
window.deleteHabit=function(i){ habits.splice(i,1); renderHabits(); saveHabits(); }

// --- Timers ---
document.getElementById("startJobBtn").addEventListener("click", ()=>startTimer('job'));
document.getElementById("stopJobBtn").addEventListener("click", ()=>stopTimer('job'));
document.getElementById("startImpactBtn").addEventListener("click", ()=>startTimer('impact'));
document.getElementById("stopImpactBtn").addEventListener("click", ()=>stopTimer('impact'));

let jobStartTime = null, impactStartTime = null;

function startTimer(type){
  if(type==="job" && !jobInterval){
    jobStartTime = Date.now();
    jobInterval = setInterval(updateTimersUI,1000);
  }
  if(type==="impact" && !impactInterval){
    impactStartTime = Date.now();
    impactInterval = setInterval(updateTimersUI,1000);
  }
}

function stopTimer(type){
  const today = getLocalDate();
  if(type==="job" && jobInterval){
    clearInterval(jobInterval); jobInterval=null;
    jobSeconds += Math.floor((Date.now() - jobStartTime)/1000);
    const hours = Math.floor(jobSeconds/3600);
    if(dailyRows[today]) dailyRows[today].jobHours += hours;
    jobSeconds = jobSeconds % 3600; // keep leftover seconds
    saveTimers(); if(dailyRows[today]) saveDailyRow(dailyRows[today]);
    renderAllRows(); updateWeeklyScore(); renderCharts();
  }
  if(type==="impact" && impactInterval){
    clearInterval(impactInterval); impactInterval=null;
    impactSeconds += Math.floor((Date.now() - impactStartTime)/1000);
    const hours = Math.floor(impactSeconds/3600);
    if(dailyRows[today]) dailyRows[today].impactHours += hours;
    impactSeconds = impactSeconds % 3600;
    saveTimers(); if(dailyRows[today]) saveDailyRow(dailyRows[today]);
    renderAllRows(); updateWeeklyScore(); renderCharts();
  }
  jobStartTime=null; impactStartTime=null;
}

function updateTimersUI(){
  let jobDisplay = jobSeconds + (jobStartTime?Math.floor((Date.now()-jobStartTime)/1000):0);
  let impactDisplay = impactSeconds + (impactStartTime?Math.floor((Date.now()-impactStartTime)/1000):0);
  document.getElementById("jobTime").innerText=formatSeconds(jobDisplay);
  document.getElementById("impactTime").innerText=formatSeconds(impactDisplay);
}

function formatSeconds(sec){
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  return `${h}h ${m}m ${s}s`;
}

// --- Autosave timers every 3 minutes ---
setInterval(()=>{ if(auth.currentUser) saveTimers(); },180000);

// --- Charts (unchanged) ---
function renderCharts(){
  const dailyCtx = document.getElementById("dailyScoreChart").getContext("2d");
  const weeklyCtx = document.getElementById("weeklyBarChart").getContext("2d");
  const monthlyCtx = document.getElementById("monthlyLineChart").getContext("2d");
  const pieCtx = document.getElementById("pieChart").getContext("2d");

  const dates = Object.keys(dailyRows).sort((a,b)=>new Date(a)-new Date(b));
  const last7 = dates.slice(-7);
  const dailyScores = last7.map(d=>calculateScore(dailyRows[d]));
  if(dailyChart) dailyChart.destroy();
  dailyChart = new Chart(dailyCtx,{type:'line',data:{labels:last7,datasets:[{label:'Daily Score',data:dailyScores,borderColor:'blue',fill:false}]}});

  const weeks = {};
  dates.forEach(d=>{
    const dateObj=new Date(d); 
    const sunday = new Date(dateObj); sunday.setDate(sunday.getDate()-dateObj.getDay());
    const key = `${sunday.getMonth()+1}/${sunday.getDate()}/${sunday.getFullYear()}`;
    if(!weeks[key]) weeks[key]=0;
    weeks[key]+=calculateScore(dailyRows[d]);
  });
  const weekLabels=Object.keys(weeks), weekScores=Object.values(weeks);
  if(weeklyChart) weeklyChart.destroy();
  weeklyChart = new Chart(weeklyCtx,{type:'bar',data:{labels:weekLabels,datasets:[{label:'Weekly Score',data:weekScores,backgroundColor:'orange'}]}});

  const last30 = dates.slice(-30), monthLabels=last30.map(d=>{const dt=new Date(d); return dt.toLocaleString('default',{month:'short',year:'2-digit'});});
  const monthScores = last30.map(d=>calculateScore(dailyRows[d]));
  if(monthlyChart) monthlyChart.destroy();
  monthlyChart = new Chart(monthlyCtx,{type:'line',data:{labels:monthLabels,datasets:[{label:'Monthly Score',data:monthScores,borderColor:'green',fill:false}]}});

  const categories=['Prayer','Mindset','Prioritize','Visualize','Exercise','Tracking','JobHours','ImpactHours','HabitSlips'];
  const totals=[0,0,0,0,0,0,0,0,0];
  for(const d in dailyRows){
    const row=dailyRows[d];
    totals[0]+=row.prayer?1:0; totals[1]+=row.mindset?1:0; totals[2]+=row.prioritize?1:0; totals[3]+=row.visualize?1:0;
    totals[4]+=row.exercise?3:0; totals[5]+=row.tracking?3:0; totals[6]+=row.jobHours; totals[7]+=row.impactHours*3; totals[8]+=row.habitSlips;
  }
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pieCtx,{type:'pie',data:{labels:categories,datasets:[{data:totals,backgroundColor:['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#00bcd4','#4caf50','#ff9800']}]}})
}
</script>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f2f2f2;}
.card{background:white;padding:20px;margin:15px auto;width:90%;max-width:1000px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
tr:nth-child(even){background:#f9f9f9;}
tr:hover{background:#eef;}
input[type="checkbox"]{transform:scale(1.2);cursor:pointer;}
button{padding:5px 10px;border:none;border-radius:6px;background:#007bff;color:white;cursor:pointer;margin:2px;}
button:hover{transform:scale(1.05);}
.header-row{display:flex;justify-content: space-between;align-items:center;}
.header-row h2{margin:0;text-align:center;width:100%;}
.header-row button{margin:0;background:#dc3545;}
.habit{margin-bottom:5px;}
#login-card{max-width:400px;margin-top:50px;text-align:center;}
#login-card input{margin:5px auto;display:block;width:80%;}
#taskInput,#habitInput{text-align:center;}
#taskList,#habitList{text-align:center;}
#jobTime,#impactTime{text-align:center;}
</style>
</head>
<body>

<div id="login-card" class="card">
<h2>Login / Signup</h2>
<p id="loginError" style="color:red;"></p>
<input id="email" type="email" placeholder="Email"><br>
<input id="password" type="password" placeholder="Password"><br>
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
</div>

<div id="app" style="display:none;">

<div class="card">
  <div class="header-row">
    <h2>Daily Tracker</h2>
    <button id="logoutBtn">Logout</button>
  </div>
  <button id="addDayBtn">Add Today</button>
  <table>
    <thead>
      <tr>
        <th>Date</th><th>Prayer</th><th>Mindset</th><th>Prioritize</th><th>Visualize</th><th>Exercise</th><th>Tracking</th><th>Habit Slips</th><th>Job Hours</th><th>Impact Hours</th><th>Score</th>
      </tr>
    </thead>
    <tbody id="dailyBody"></tbody>
  </table>
  <p id="weeklyScore">Weekly Score: 0</p>
</div>

<div class="card"><h2>Tasks</h2><input id="taskInput" placeholder="New Task"><button id="addTaskBtn">Add Task</button><button id="resetTasksBtn">Reset</button><div id="taskList"></div></div>

<div class="card"><h2>Habits</h2><input id="habitInput" placeholder="New Habit"><button id="addHabitBtn">Add Habit</button><div id="habitList"></div></div>

<div class="card"><h2>Timers</h2>
  <button id="startJobBtn">Start Job Hours</button>
  <button id="stopJobBtn">Stop Job Hours</button>
  <p id="jobTime">0h 0m 0s</p>
  <button id="startImpactBtn">Start Impact Hours</button>
  <button id="stopImpactBtn">Stop Impact Hours</button>
  <p id="impactTime">0h 0m 0s</p>
</div>

<div class="card"><h2>Charts</h2>
  <canvas id="dailyScoreChart"></canvas>
  <canvas id="weeklyBarChart"></canvas>
  <canvas id="monthlyLineChart"></canvas>
  <canvas id="pieChart"></canvas>
</div>

</div>
</body>
</html>
