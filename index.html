<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personal Growth Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
  // =========================
  // Firebase Initialization
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, setDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD4IYJo_cNRILK3KmmDExpmuO7F4c_izN4",
    authDomain: "growth-tracker-a367c.firebaseapp.com",
    projectId: "growth-tracker-a367c",
    storageBucket: "growth-tracker-a367c.appspot.com",
    messagingSenderId: "277469925642",
    appId: "1:277469925642:web:f79c6f277931c969bfaaf3",
    measurementId: "G-DPYPWBMHLB"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // =========================
  // DOM Elements
  // =========================
  const authSection = document.getElementById("auth-section");
  const trackerContainer = document.getElementById("tracker-container");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const signupBtn = document.getElementById("signup-btn");
  const signinBtn = document.getElementById("signin-btn");
  const googleSigninBtn = document.getElementById("google-signin-btn");
  const authMsg = document.getElementById("auth-msg");
  
  const addDayBtn = document.getElementById("add-day-btn");
  const trackerTbody = document.getElementById("tracker-tbody");
  const taskCheckboxes = document.querySelectorAll(".task-checkbox");

  const jobDisplay = document.getElementById('job-timer-display');
  const impactDisplay = document.getElementById('impact-timer-display');

  const weeklyTotalEl = document.getElementById("weekly-total");
  const crusadeLevelEl = document.getElementById("crusade-level");
  const levelStreakEl = document.getElementById("level-streak");

  const habitContainer = document.getElementById('habit-breaking-container');
  const addHabitBtn = document.getElementById('add-habit-btn');

  // =========================
  // Auth Logic
  // =========================
  signupBtn.addEventListener("click", async () => {
    try {
      await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    } catch(e){ authMsg.textContent = e.message; }
  });
  signinBtn.addEventListener("click", async () => {
    try {
      await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    } catch(e){ authMsg.textContent = e.message; }
  });
  googleSigninBtn.addEventListener("click", async () => {
    const provider = new GoogleAuthProvider();
    try { await signInWithPopup(auth, provider); }
    catch(e){ authMsg.textContent = e.message; }
  });

  onAuthStateChanged(auth, user => {
    if(user){ authSection.classList.add("hidden"); trackerContainer.classList.remove("hidden"); loadData(user.uid); }
    else{ authSection.classList.remove("hidden"); trackerContainer.classList.add("hidden"); }
  });

  // =========================
  // Tracker Data
  // =========================
  let trackerData = []; // array of daily objects
  let habits = [];
  let jobTimer = 0, impactTimer = 0;
  let jobInterval, impactInterval;

  // =========================
  // Timer Functions
  // =========================
  function formatTime(sec){
    const h = String(Math.floor(sec/3600)).padStart(2,'0');
    const m = String(Math.floor((sec%3600)/60)).padStart(2,'0');
    const s = String(sec%60).padStart(2,'0');
    return `${h}:${m}:${s}`;
  }
  function startTimer(type){ 
    if(type==='job') jobInterval = setInterval(()=>{jobTimer++; jobDisplay.textContent=formatTime(jobTimer)},1000);
    else impactInterval = setInterval(()=>{impactTimer++; impactDisplay.textContent=formatTime(impactTimer)},1000);
  }
  function stopTimer(type){ if(type==='job') clearInterval(jobInterval); else clearInterval(impactInterval); }
  function logTimer(type){ 
    if(type==='job'){ alert(`Logged ${formatTime(jobTimer)} job hours`); jobTimer=0; jobDisplay.textContent=formatTime(0); }
    else{ alert(`Logged ${formatTime(impactTimer)} impact hours`); impactTimer=0; impactDisplay.textContent=formatTime(0); }
  }

  document.getElementById('job-start-btn').addEventListener('click',()=>startTimer('job'));
  document.getElementById('job-stop-btn').addEventListener('click',()=>stopTimer('job'));
  document.getElementById('job-log-btn').addEventListener('click',()=>logTimer('job'));
  document.getElementById('impact-start-btn').addEventListener('click',()=>startTimer('impact'));
  document.getElementById('impact-stop-btn').addEventListener('click',()=>stopTimer('impact'));
  document.getElementById('impact-log-btn').addEventListener('click',()=>logTimer('impact'));

  // =========================
  // Habit Functions
  // =========================
  function renderHabits(){
    habitContainer.innerHTML="";
    habits.forEach((habit,index)=>{
      const div = document.createElement('div');
      div.className='bg-gray-50 p-4 rounded-lg shadow flex flex-col items-center';
      div.innerHTML=`
        <input data-index="${index}" type="text" class="habit-name-input text-center border-b border-gray-300 focus:outline-none mb-2" value="${habit.name}" placeholder="Habit name"/>
        <p>Current Streak: <span class="habit-streak" data-index="${index}">${habit.streak}</span></p>
        <div class="flex space-x-2 mt-2">
          <button data-index="${index}" class="habit-reset-btn bg-yellow-400 text-white px-2 py-1 rounded-lg text-sm">Reset</button>
          <button data-index="${index}" class="delete-habit-btn bg-red-500 text-white px-2 py-1 rounded-lg text-sm">Delete</button>
        </div>
        <label class="mt-2 flex items-center space-x-2 text-sm">
          <input data-index="${index}" type="checkbox" class="habit-slip-checkbox"/>
          Mark Slip
        </label>
      `;
      habitContainer.appendChild(div);
    });
  }

  addHabitBtn.addEventListener('click',()=>{
    habits.push({name:'',streak:0});
    renderHabits();
  });

  habitContainer.addEventListener('click',(e)=>{
    const index = e.target.dataset.index;
    if(e.target.classList.contains('delete-habit-btn')){ habits.splice(index,1); renderHabits(); }
    if(e.target.classList.contains('habit-reset-btn')){ habits[index].streak=0; renderHabits(); }
  });

  habitContainer.addEventListener('change',(e)=>{
    const index = e.target.dataset.index;
    if(e.target.classList.contains('habit-slip-checkbox')){
      habits[index].streak=0; renderHabits(); 
      // sync with daily tracker habit slips
      if(trackerData.length>0){ trackerData[trackerData.length-1].habitSlips++; updateTable(); saveData(); }
    }
    if(e.target.classList.contains('habit-name-input')){ habits[index].name = e.target.value; }
  });

  // =========================
  // Daily Tracker Functions
  // =========================
  function addDay(){
    const today = new Date().toLocaleDateString();
    const dayObj = {
      date: today, prayer:false, mindset:false, prioritize:false, visualize:false,
      exercise:false, tracking:false, habitSlips:0, jobHours:0, impactHours:0, dailyScore:0
    };
    trackerData.push(dayObj);
    renderTable();
    saveData();
  }

  addDayBtn.addEventListener('click',addDay);

  function renderTable(){
    trackerTbody.innerHTML="";
    trackerData.forEach((day,index)=>{
      const row = document.createElement('tr');
      row.className="border-b border-gray-300";
      row.innerHTML=`
        <td>${day.date}</td>
        <td><input type="checkbox" data-day="${index}" class="daily-checkbox" data-field="prayer" ${day.prayer?'checked':''}></td>
        <td><input type="checkbox" data-day="${index}" class="daily-checkbox" data-field="mindset" ${day.mindset?'checked':''}></td>
        <td><input type="checkbox" data-day="${index}" class="daily-checkbox" data-field="prioritize" ${day.prioritize?'checked':''}></td>
        <td><input type="checkbox" data-day="${index}" class="daily-checkbox" data-field="visualize" ${day.visualize?'checked':''}></td>
        <td><input type="checkbox" data-day="${index}" class="daily-checkbox" data-field="exercise" ${day.exercise?'checked':''}></td>
        <td><input type="checkbox" data-day="${index}" class="daily-checkbox" data-field="tracking" ${day.tracking?'checked':''}></td>
        <td><input type="number" min="0" data-day="${index}" class="habit-slip-input" value="${day.habitSlips}"></td>
        <td><input type="number" min="0" data-day="${index}" class="job-hours-input" value="${day.jobHours}"></td>
        <td><input type="number" min="0" data-day="${index}" class="impact-hours-input" value="${day.impactHours}"></td>
        <td>${day.dailyScore}</td>
      `;
      trackerTbody.appendChild(row);
    });
    attachRowListeners();
    updateCharts();
    updateGrowthLevel();
  }

  function attachRowListeners(){
    document.querySelectorAll(".daily-checkbox").forEach(cb=>{
      cb.addEventListener("change",e=>{
        const dayIndex = e.target.dataset.day;
        const field = e.target.dataset.field;
        trackerData[dayIndex][field]=e.target.checked;
        // Any checkbox marked counts as tracking
        trackerData[dayIndex].tracking=true;
        updateTable();
        saveData();
      });
    });
    document.querySelectorAll(".habit-slip-input").forEach(input=>{
      input.addEventListener("input",e=>{
        const dayIndex = e.target.dataset.day;
        trackerData[dayIndex].habitSlips = Number(e.target.value);
        updateTable(); saveData();
      });
    });
    document.querySelectorAll(".job-hours-input").forEach(input=>{
      input.addEventListener("input",e=>{
        const dayIndex = e.target.dataset.day;
        trackerData[dayIndex].jobHours = Number(e.target.value);
        updateTable(); saveData();
      });
    });
    document.querySelectorAll(".impact-hours-input").forEach(input=>{
      input.addEventListener("input",e=>{
        const dayIndex = e.target.dataset.day;
        trackerData[dayIndex].impactHours = Number(e.target.value);
        updateTable(); saveData();
      });
    });
  }

  function updateTable(){
    trackerData.forEach(day=>{
      day.dailyScore = 0;
      if(day.prayer) day.dailyScore++;
      if(day.mindset) day.dailyScore++;
      if(day.prioritize) day.dailyScore++;
      if(day.visualize) day.dailyScore++;
      if(day.exercise) day.dailyScore +=3;
      if(day.tracking) day.dailyScore +=3;
      day.dailyScore += day.jobHours;
      day.dailyScore += day.impactHours*3;
      day.dailyScore -= day.habitSlips;
    });
    renderTable();
  }

  // =========================
  // Firebase Functions
  // =========================
  async function saveData(){
    const user = auth.currentUser;
    if(!user) return;
    await setDoc(doc(db,"users",user.uid),{
      trackerData: trackerData,
      habits: habits
    });
  }

  async function loadData(uid){
    const docRef = doc(db,"users",uid);
    const docSnap = await getDocs(collection(db,"users"));
    const userDoc = docSnap.docs.find(d=>d.id===uid);
    if(userDoc){
      const data = userDoc.data();
      trackerData = data.trackerData || [];
      habits = data.habits || [];
      renderTable();
      renderHabits();
    }
  }

  // =========================
  // Charts
  // =========================
  const dailyCtx = document.getElementById('dailyChart').getContext('2d');
  const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
  let dailyChart = new Chart(dailyCtx,{type:'bar',data:{labels:[],datasets:[{label:'Daily Score',data:[],backgroundColor:'rgba(99,102,241,0.6)'}]},options:{responsive:true}});
  let weeklyChart = new Chart(weeklyCtx,{type:'line',data:{labels:[],datasets:[{label:'Weekly Total',data:[],borderColor:'rgba(16,185,129,1)',fill:false}]}});
  
  function updateCharts(){
    // Daily chart
    dailyChart.data.labels = trackerData.map(d=>d.date);
    dailyChart.data.datasets[0].data = trackerData.map(d=>d.dailyScore);
    dailyChart.update();
    // Weekly chart
    const weeklyTotals = [];
    for(let i=0;i<trackerData.length;i+=7){
      weeklyTotals.push(trackerData.slice(i,i+7).reduce((sum,d)=>sum+d.dailyScore,0));
    }
    weeklyChart.data.labels = weeklyTotals.map((_,i)=>`Week ${i+1}`);
    weeklyChart.data.datasets[0].data = weeklyTotals;
    weeklyChart.update();
    weeklyTotalEl.textContent = weeklyTotals[weeklyTotals.length-1] || 0;
  }

  // =========================
  // Growth Level
  // =========================
  function updateGrowthLevel(){
    const weeklyTotals = [];
    for(let i=0;i<trackerData.length;i+=7){
      weeklyTotals.push(trackerData.slice(i,i+7).reduce((sum,d)=>sum+d.dailyScore,0));
    }
    const lastWeek = weeklyTotals[weeklyTotals.length-1]||0;
    let level=1;
    if(lastWeek>=112 && lastWeek<=125) level=2;
    else if(lastWeek>=126 && lastWeek<=140) level=3;
    else if(lastWeek>=141 && lastWeek<=170) level=4;
    crusadeLevelEl.textContent = `Level ${level}`;
    // Level up streak
    let streak=0;
    for(let i=weeklyTotals.length-1;i>=0;i--){
      const w=weeklyTotals[i];
      const nextLevelTotal = level===2?112:level===3?126:level===4?141:0;
      if(w>=nextLevelTotal) streak++;
      else break;
    }
    levelStreakEl.textContent = streak;
  }
</script>
</body>
</html>
