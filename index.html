<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Growth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 6px 8px -3px rgba(0, 0, 0, 0.05);
        }
        input[type="number"] {
            -moz-appearance: textfield;
            text-align: center;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">Personal Growth Tracker</h1>
        
        <!-- Daily Tracker Section -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Daily Tracker</h2>
            <div id="tracker-table-container" class="overflow-x-auto">
                <!-- Table will be generated here by JavaScript -->
            </div>
            <div class="mt-4 text-center">
                <button id="add-day-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 active:scale-95 transition duration-300">Add Day</button>
            </div>
        </div>

        <!-- Prioritization Checklist Section -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-2 text-center">Prioritization Checklist</h2>
            <div id="prioritization-list" class="space-y-4">
                <!-- Prioritization items will be generated here -->
            </div>
        </div>
        
        <!-- Job Hours and Impact Hours Timers -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Timers</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <!-- Job Hours Timer -->
                <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Job Hours</h3>
                    <p id="job-timer-display" class="text-3xl font-mono text-gray-800 mb-4">00:00:00</p>
                    <div class="flex justify-center space-x-4">
                        <button id="job-start-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 active:scale-95 transition duration-300">Start</button>
                        <button id="job-stop-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 active:scale-95 transition duration-300">Stop</button>
                        <button id="job-log-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 active:scale-95 transition duration-300">Log</button>
                    </div>
                </div>

                <!-- Impact Hours Timer -->
                <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Impact Hours</h3>
                    <p id="impact-timer-display" class="text-3xl font-mono text-gray-800 mb-4">00:00:00</p>
                    <div class="flex justify-center space-x-4">
                        <button id="impact-start-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 active:scale-95 transition duration-300">Start</button>
                        <button id="impact-stop-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 active:scale-95 transition duration-300">Stop</button>
                        <button id="impact-log-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 active:scale-95 transition duration-300">Log</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Habit Breaking Section -->
        <div class="card mt-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700 text-center">Habit Breaking</h2>
                <button id="add-habit-btn" class="bg-green-500 text-white text-sm font-bold py-1 px-3 rounded-lg hover:bg-green-600 active:scale-95 transition duration-300">Add Habit</button>
            </div>
            <div id="habit-breaking-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Habits will be dynamically added here -->
            </div>
        </div>

        <!-- Weekly Total, Growth Level, and Level Up Streak -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 mb-6">
            <div class="card text-center">
                <h2 class="text-lg font-bold text-gray-700 mb-2">Weekly Total</h2>
                <p id="weekly-total" class="text-4xl font-extrabold text-indigo-600">0</p>
            </div>
            <div class="card text-center">
                <h2 class="text-lg font-bold text-gray-700 mb-2">Growth Level <button id="explain-level-btn" class="text-sm text-indigo-500 hover:text-indigo-700 font-normal active:scale-95 transition duration-300">What's this? ✨</button></h2>
                <p id="crusade-level" class="text-2xl font-bold text-teal-600">Below Growth Level One</p>
                <p id="level-explanation" class="text-xs text-gray-500 mt-2 italic hidden"></p>
            </div>
            <div class="card text-center">
                <h2 class="text-lg font-bold text-gray-700 mb-2">Level Up Streak</h2>
                <p id="level-streak" class="text-4xl font-extrabold text-blue-600">0</p>
            </div>
        </div>
        
        <!-- Progress Chart Section -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-2 text-center">Progress Chart</h2>
            <div class="mx-auto max-w-xl">
                <canvas id="progressChart" class="bg-gray-50 rounded-lg p-2"></canvas>
            </div>
        </div>

        <!-- Daily Reflection and Weekly Summary Section -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Insights</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Daily Reflection</h3>
                    <button id="reflection-btn" class="w-full bg-purple-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-600 active:scale-95 transition duration-300">Generate ✨</button>
                    <p id="reflection-output" class="mt-4 text-gray-700 italic text-sm"></p>
                </div>
                <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Weekly Summary</h3>
                    <button id="weekly-summary-btn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 active:scale-95 transition duration-300">Generate ✨</button>
                    <p id="weekly-summary-output" class="mt-4 text-gray-700 italic text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Impact Hours Explanation Section -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-2 text-center">What Are Impact Hours?</h2>
            <p class="text-gray-700 mb-2">Impact hours are focused, high-leverage activities that contribute directly to your personal and professional growth. They are designed to move you closer to your long-term goals. Examples include:</p>
            <ul class="list-disc list-inside space-y-1 text-gray-700">
                <li>Studying valuable skills</li>
                <li>Practicing your craft</li>
                <li>Designing a product</li>
                <li>Focused work on your mission</li>
                <li>Recording content</li>
                <li>Building your business</li>
            </ul>
        </div>

        <div class="mt-6 text-center text-gray-600 text-sm">
            <p id="user-id-display" class="font-mono break-all"></p>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let db;
    let auth;
    let userId;
    let myChart = null; // Store the Chart.js instance

    // --- Habit Breaking Logic ---
    const habitsDocRef = () => doc(db, `/artifacts/${appId}/users/${userId}/habit_breaking`, 'habits');

    const addHabit = async () => {
        console.log("Attempting to add new habit...");
        try {
            if (!db || !userId) {
                console.error("Database or user not ready.");
                return;
            }
            const docSnap = await getDoc(habitsDocRef());
            const currentHabits = docSnap.data()?.habits || [];
            currentHabits.push({ name: '', lastSlipDate: null, longestStreak: 0 });
            await setDoc(habitsDocRef(), { habits: currentHabits });
            console.log("Habit successfully added to Firestore.");
        } catch (error) {
            console.error("Error adding new habit:", error);
        }
    };


    document.addEventListener('DOMContentLoaded', async () => {
        const trackerTableContainer = document.getElementById('tracker-table-container');
        const addDayBtn = document.getElementById('add-day-btn');
        const weeklyTotalEl = document.getElementById('weekly-total');
        const crusadeLevelEl = document.getElementById('crusade-level');
        const levelStreakEl = document.getElementById('level-streak');
        const userIdDisplay = document.getElementById('user-id-display');
        const explainLevelBtn = document.getElementById('explain-level-btn');
        const levelExplanationOutput = document.getElementById('level-explanation');
        const reflectionBtn = document.getElementById('reflection-btn');
        const reflectionOutput = document.getElementById('reflection-output');
        const weeklySummaryBtn = document.getElementById('weekly-summary-btn');
        const weeklySummaryOutput = document.getElementById('weekly-summary-output');
        const prioritizationList = document.getElementById('prioritization-list');
        const progressChartEl = document.getElementById('progressChart');
        const habitBreakingContainer = document.getElementById('habit-breaking-container');
        const addHabitBtn = document.getElementById('add-habit-btn');


        // Timer elements
        const jobTimerDisplay = document.getElementById('job-timer-display');
        const jobStartBtn = document.getElementById('job-start-btn');
        const jobStopBtn = document.getElementById('job-stop-btn');
        const jobLogBtn = document.getElementById('job-log-btn');
        const impactTimerDisplay = document.getElementById('impact-timer-display');
        const impactStartBtn = document.getElementById('impact-start-btn');
        const impactStopBtn = document.getElementById('impact-stop-btn');
        const impactLogBtn = document.getElementById('impact-log-btn');

        // Timer state for both timers, now stored in local storage for a better user experience
        let jobTimer = {
            intervalId: null,
            startTime: 0,
            elapsedTime: 0
        };
        let impactTimer = {
            intervalId: null,
            startTime: 0,
            elapsedTime: 0
        };

        // --- Event Listeners for static buttons ---
        // This is a crucial fix to ensure the button listener is always attached.
        addHabitBtn.addEventListener('click', addHabit);

        // --- Firebase Initialization and Authentication ---
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;
                console.log("Firebase initialized and user authenticated:", userId);

                // IMPORTANT: Call this function on auth state change to ensure docs are always present
                await createTodayDocs();
                
                // Once authenticated, start listening to Firestore data
                const crusadeCollection = collection(db, `/artifacts/${appId}/users/${userId}/crusade_data`);
                onSnapshot(crusadeCollection, (snapshot) => {
                    const dailyData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderTable(dailyData);
                    updateDashboard(dailyData);
                    renderProgressChart(dailyData);
                }, (error) => {
                    console.error("Error listening to Firestore changes:", error);
                });

                // Listen for priority data
                const today = getTodayDateString();
                const priorityDocRef = doc(db, `/artifacts/${appId}/users/${userId}/priorities`, today);
                onSnapshot(priorityDocRef, (docSnapshot) => {
                    const data = docSnapshot.data()?.tasks || [];
                    renderPriorities(data);
                }, (error) => {
                    console.error("Error listening to priority data:", error);
                });

                // Listen for habit breaking data
                const habitsDocRef = doc(db, `/artifacts/${appId}/users/${userId}/habit_breaking`, 'habits');
                onSnapshot(habitsDocRef, (docSnapshot) => {
                    const data = docSnapshot.data() || {
                        habits: []
                    };
                    renderHabitBreakingSection(data.habits);
                }, (error) => {
                    console.error("Error listening to habit breaking data:", error);
                });


            } else {
                console.log("No user signed in. Signing in anonymously...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    userIdDisplay.textContent = "Authentication failed. Please try again.";
                }
            }
        });
        
        // --- End Firebase Initialization ---

        const saveTimerState = () => {
            localStorage.setItem('jobTimerState', JSON.stringify({
                elapsedTime: jobTimer.elapsedTime,
                startTime: jobTimer.startTime
            }));
            localStorage.setItem('impactTimerState', JSON.stringify({
                elapsedTime: impactTimer.elapsedTime,
                startTime: impactTimer.startTime
            }));
        };

        const loadTimerState = () => {
            const storedJobState = localStorage.getItem('jobTimerState');
            if (storedJobState) {
                const state = JSON.parse(storedJobState);
                jobTimer.elapsedTime = state.elapsedTime || 0;
                jobTimer.startTime = state.startTime || 0;
                if (jobTimer.startTime !== 0) {
                    startTimer(jobTimer, jobTimerDisplay, 'job');
                } else {
                    updateTimerDisplay(jobTimer.elapsedTime, jobTimerDisplay);
                }
            }
            const storedImpactState = localStorage.getItem('impactTimerState');
            if (storedImpactState) {
                const state = JSON.parse(storedImpactState);
                impactTimer.elapsedTime = state.elapsedTime || 0;
                impactTimer.startTime = state.startTime || 0;
                if (impactTimer.startTime !== 0) {
                    startTimer(impactTimer, impactTimerDisplay, 'impact');
                } else {
                    updateTimerDisplay(impactTimer.elapsedTime, impactTimerDisplay);
                }
            }
        };

        const getDailyScore = (day) => {
            let score = 0;
            score += (day.prayer || 0);
            score += (day.mindsetWork || 0);
            score += (day.prioritize || 0);
            score += (day.exercise || 0) * 3;
            score += (day.visualize || 0);
            score += (day.tracking || 0) * 3;
            score -= (day.habitFastSlips || 0);
            score += (day.jobHours || 0);
            score += (day.impactHours || 0) * 3;
            return score;
        };

        const renderTable = (data) => {
            trackerTableContainer.innerHTML = '';
            if (data.length === 0) {
                trackerTableContainer.innerHTML = '<p class="text-center text-gray-500">No data to display. Click "Add Day" to begin.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = "min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden";
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Prayer (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Mindset Work (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Prioritize (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Visualize (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Exercise (+3)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Tracking (+3)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Habit Slips (-1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Job Hours (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Impact Hours (+3)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Daily Score</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                </tbody>
            `;
            const tbody = table.querySelector('tbody');

            data.sort((a, b) => a.date.localeCompare(b.date));

            data.forEach((day, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                // Fix: Manually format the date to avoid timezone issues with `new Date()`
                const [year, month, dateDay] = day.date.split('-');
                const formattedDate = `${month}/${dateDay}`;

                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${formattedDate}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="prayer" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.prayer ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="mindsetWork" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.mindsetWork ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="prioritize" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.prioritize ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="visualize" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.visualize ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="exercise" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.exercise ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="tracking" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.tracking ? 'checked' : ''} disabled>
                    </td>
                    <td class="px-4 py-2 whitespace-now-wrap text-sm text-center">
                        <!-- Habit slips are now automatically updated by the new section -->
                        <input type="number" data-field="habitFastSlips" value="${day.habitFastSlips || 0}" class="w-12 text-center border rounded-md" disabled>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="number" data-field="jobHours" value="${day.jobHours || 0}" class="w-12 text-center border rounded-md" disabled>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="number" data-field="impactHours" value="${day.impactHours || 0}" class="w-12 text-center border rounded-md" disabled>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-bold text-gray-900 text-center">${getDailyScore(day)}</td>
                `;

                const coreCheckboxes = row.querySelectorAll('input[type="checkbox"]:not([data-field="tracking"])');

                // Listener for updating the tracking status and other fields
                coreCheckboxes.forEach(input => {
                    input.addEventListener('change', async () => {
                        const field = input.dataset.field;
                        let value = input.checked ? 1 : 0;
                        const docRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, day.id);
                        
                        await setDoc(docRef, { [field]: value }, { merge: true }).catch(console.error);

                        // Check if at least one core checkbox is checked to update 'tracking'
                        const updatedData = (await getDoc(docRef)).data();
                        const trackingValue = (updatedData.prayer || updatedData.mindsetWork || updatedData.prioritize || updatedData.visualize || updatedData.exercise) ? 1 : 0;
                        await updateDoc(docRef, { tracking: trackingValue });
                    });
                });

                row.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const field = e.target.dataset.field;
                        const value = parseInt(e.target.value, 10) || 0;
                        const docRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, day.id);
                        setDoc(docRef, { [field]: value }, { merge: true }).catch(console.error);
                    });
                });

                tbody.appendChild(row);
            });
            trackerTableContainer.appendChild(table);
        };

        const updateDashboard = (data) => {
            const dailyScores = data.slice(-7).map(day => getDailyScore(day));
            const weeklyTotal = dailyScores.reduce((sum, score) => sum + score, 0);
            weeklyTotalEl.textContent = weeklyTotal;
            crusadeLevelEl.textContent = getGrowthLevel(weeklyTotal);
            levelStreakEl.textContent = getLevelStreak(weeklyTotal);
        };

        // --- Chart.js Logic ---
        const renderProgressChart = (data) => {
            const sortedData = data.sort((a, b) => a.date.localeCompare(b.date));
            const last30DaysData = sortedData.slice(-30);
            const labels = last30DaysData.map(day => {
                const [, month, dayOfMonth] = day.date.split('-');
                return `${month}/${dayOfMonth}`;
            });
            const scores = last30DaysData.map(day => getDailyScore(day));

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Daily Score',
                    data: scores,
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Score',
                            color: '#4b5563'
                        },
                        ticks: {
                            color: '#4b5563'
                        },
                        grid: {
                            color: 'rgba(209, 213, 219, 0.5)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            color: '#4b5563'
                        },
                        ticks: {
                            color: '#4b5563'
                        },
                        grid: {
                            color: 'rgba(209, 213, 219, 0.5)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                }
            };

            if (myChart) {
                myChart.data = chartData;
                myChart.update();
            } else {
                myChart = new Chart(progressChartEl, {
                    type: 'line',
                    data: chartData,
                    options: chartOptions
                });
            }
        };

        const getGrowthLevel = (score) => {
            if (score >= 141) return "Growth Level Four";
            if (score >= 126) return "Growth Level Three";
            if (score >= 112) return "Growth Level Two";
            if (score >= 99) return "Growth Level One";
            return "Below Growth Level One";
        };

        const getLevelStreak = (score) => {
            const storedStreak = localStorage.getItem('levelStreak');
            const streak = storedStreak ? parseInt(storedStreak, 10) : 0;
            const currentLevel = getGrowthLevel(score);
            if (currentLevel === localStorage.getItem('lastLevel')) {
                if (currentLevel !== "Below Growth Level One" && score >= getLevelPoints(currentLevel)) {
                    const newStreak = streak + 1;
                    localStorage.setItem('levelStreak', newStreak);
                    localStorage.setItem('lastLevel', currentLevel);
                    return newStreak;
                } else {
                    return streak;
                }
            } else {
                localStorage.setItem('levelStreak', 0);
                localStorage.setItem('lastLevel', currentLevel);
                return 0;
            }
        };

        const getLevelPoints = (level) => {
            switch (level) {
                case "Growth Level One": return 99;
                case "Growth Level Two": return 112;
                case "Growth Level Three": return 126;
                case "Growth Level Four": return 141;
                default: return 0;
            }
        };

        // Helper function to get the current date string in YYYY-MM-DD format
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // Function to create a new day and priorities docs if they don't exist
        const createTodayDocs = async () => {
             if (!db || !userId) {
                console.error("Database or user not ready.");
                return;
            }
            const today = getTodayDateString();
            const crusadeDocRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, today);
            const crusadeDocSnap = await getDoc(crusadeDocRef);

            if (!crusadeDocSnap.exists()) {
                 const newDay = {
                    date: today,
                    prayer: 0, mindsetWork: 0, prioritize: 0, exercise: 0, visualize: 0, tracking: 0,
                    habitFastSlips: 0, jobHours: 0, impactHours: 0
                };
                await setDoc(crusadeDocRef, newDay);
            }

            const priorityDocRef = doc(db, `/artifacts/${appId}/users/${userId}/priorities`, today);
            const priorityDocSnap = await getDoc(priorityDocRef);

            if (!priorityDocSnap.exists()) {
                const defaultPriorities = {
                    tasks: [
                        { text: '', completed: false },
                        { text: '', completed: false },
                        { text: '', completed: false }
                    ]
                };
                await setDoc(priorityDocRef, defaultPriorities);
            }
        };

        addDayBtn.addEventListener('click', async () => {
            try {
                await createTodayDocs();
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        });

        // --- Timer Logic ---
        const formatTime = (ms) => {
            const seconds = Math.floor(ms / 1000) % 60;
            const minutes = Math.floor(ms / (1000 * 60)) % 60;
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const pad = (num) => num.toString().padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        };
        const updateTimerDisplay = (elapsedTime, display) => {
            display.textContent = formatTime(elapsedTime);
        };
        const startTimer = (timer, display) => {
            if (timer.intervalId) return;
            timer.startTime = Date.now() - timer.elapsedTime;
            timer.intervalId = setInterval(() => {
                timer.elapsedTime = Date.now() - timer.startTime;
                updateTimerDisplay(timer.elapsedTime, display);
                saveTimerState();
            }, 1000);
        };
        const stopTimer = (timer) => {
            clearInterval(timer.intervalId);
            timer.intervalId = null;
            saveTimerState();
        };
        const resetTimer = (timer, display) => {
            stopTimer(timer);
            timer.elapsedTime = 0;
            timer.startTime = 0;
            updateTimerDisplay(timer.elapsedTime, display);
            saveTimerState();
        };

        // Logs hours from a timer to the daily tracker
        const logHours = async (timer, field) => {
            if (!db || !userId) {
                console.error("Database or user not ready.");
                return;
            }
            
            const today = getTodayDateString();
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, today);
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                await createTodayDocs();
            }

            const hoursToAdd = (timer.elapsedTime / (1000 * 60 * 60));
            const roundedHours = Math.round(hoursToAdd * 100) / 100;
            
            const currentHours = docSnap.data()?.[field] || 0;
            await updateDoc(docRef, { [field]: currentHours + roundedHours });
            
            resetTimer(timer, (field === 'jobHours' ? jobTimerDisplay : impactTimerDisplay));
        };

        jobStartBtn.addEventListener('click', () => startTimer(jobTimer, jobTimerDisplay));
        jobStopBtn.addEventListener('click', () => stopTimer(jobTimer));
        jobLogBtn.addEventListener('click', () => logHours(jobTimer, 'jobHours'));

        impactStartBtn.addEventListener('click', () => startTimer(impactTimer, impactTimerDisplay));
        impactStopBtn.addEventListener('click', () => stopTimer(impactTimer));
        impactLogBtn.addEventListener('click', () => logHours(impactTimer, 'impactHours'));

        loadTimerState();

        // --- Prioritization Logic ---
        const renderPriorities = (tasks) => {
            prioritizationList.innerHTML = '';
            tasks.forEach((task, index) => {
                const item = document.createElement('div');
                item.className = "flex items-center space-x-2";
                item.innerHTML = `
                    <input type="checkbox" id="priority-${index}" class="accent-indigo-600 w-4 h-4 rounded-sm" ${task.completed ? 'checked' : ''}>
                    <label for="priority-${index}" class="flex-grow">
                        <input type="text" value="${task.text}" placeholder="Objective ${index + 1}" class="w-full border-b-2 border-gray-200 focus:border-indigo-500 focus:outline-none transition duration-300 px-2 py-1 bg-transparent text-gray-800">
                    </label>
                `;
                
                const checkbox = item.querySelector('input[type="checkbox"]');
                const textInput = item.querySelector('input[type="text"]');

                // Update Firestore when checkbox is checked/unchecked
                checkbox.addEventListener('change', async () => {
                    if (!db || !userId) return;
                    const today = getTodayDateString();
                    const docRef = doc(db, `/artifacts/${appId}/users/${userId}/priorities`, today);
                    const tasksCopy = [...tasks];
                    tasksCopy[index].completed = checkbox.checked;
                    await updateDoc(docRef, { tasks: tasksCopy });
                    
                    // Check if all priorities are complete and update daily tracker
                    const allCompleted = tasksCopy.every(t => t.completed);
                    const dailyTrackerDocRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, today);
                    await updateDoc(dailyTrackerDocRef, { prioritize: allCompleted ? 1 : 0 });
                });

                // Update Firestore when text changes
                textInput.addEventListener('change', async () => {
                    if (!db || !userId) return;
                    const today = getTodayDateString();
                    const docRef = doc(db, `/artifacts/${appId}/users/${userId}/priorities`, today);
                    const tasksCopy = [...tasks];
                    tasksCopy[index].text = textInput.value;
                    await updateDoc(docRef, { tasks: tasksCopy });
                });

                prioritizationList.appendChild(item);
            });
        };

        const renderHabitBreakingSection = (habits) => {
            habitBreakingContainer.innerHTML = '';
            const today = getTodayDateString();

            habits.forEach((habit, index) => {
                const habitDiv = document.createElement('div');
                habitDiv.className = "flex flex-col items-center p-4 bg-gray-50 rounded-lg relative";
                habitDiv.innerHTML = `
                    <button class="absolute top-2 right-2 text-red-500 hover:text-red-700 active:scale-95 transition duration-300 delete-habit-btn" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <input type="text" data-index="${index}" value="${habit.name}" placeholder="Habit to Break #${index + 1}" class="text-center font-bold text-lg mb-2 w-full bg-transparent focus:outline-none focus:border-indigo-500 rounded-md border-b-2 border-gray-200 p-2 habit-name-input">
                    <div class="flex items-center space-x-4 mt-2 mb-4">
                        <label for="habit-slip-${index}" class="text-gray-700">Had a slip today?</label>
                        <input type="checkbox" id="habit-slip-${index}" data-index="${index}" class="accent-red-500 rounded-sm w-5 h-5 habit-slip-checkbox">
                    </div>
                    <p class="text-sm text-gray-500">Days Without Slip: <span data-index="${index}" class="text-base font-bold text-green-600 habit-streak">0</span></p>
                    <p class="text-sm text-gray-500">Longest Streak: <span data-index="${index}" class="text-base font-bold text-indigo-600 habit-longest-streak">0</span></p>
                    <button data-index="${index}" class="bg-red-500 text-white text-sm py-1 px-3 rounded-lg hover:bg-red-600 active:scale-95 transition duration-300 mt-2 habit-reset-btn">Reset Streak</button>
                `;
                habitBreakingContainer.appendChild(habitDiv);

                const lastSlipDate = habit.lastSlipDate ? new Date(habit.lastSlipDate) : null;
                const currentStreak = lastSlipDate ? Math.max(0, Math.floor((new Date() - lastSlipDate) / (1000 * 60 * 60 * 24))) : 0;
                habitDiv.querySelector('.habit-streak').textContent = currentStreak;
                habitDiv.querySelector('.habit-longest-streak').textContent = habit.longestStreak;
            });
            
            // Re-attach event listeners to all dynamically created elements
            attachHabitEventListeners(habits);
        };

        const attachHabitEventListeners = (habits) => {
            document.querySelectorAll('.habit-name-input').forEach(input => {
                input.onchange = (e) => updateHabitData(e.target.dataset.index, 'name', e.target.value);
            });

            document.querySelectorAll('.habit-slip-checkbox').forEach(checkbox => {
                checkbox.onchange = async (e) => {
                    if (e.target.checked) {
                        const index = e.target.dataset.index;
                        const currentStreak = parseInt(document.querySelector(`.habit-streak[data-index="${index}"]`).textContent);
                        await handleSlip(index, currentStreak);
                    }
                };
            });

            document.querySelectorAll('.habit-reset-btn').forEach(btn => {
                btn.onclick = (e) => handleReset(e.target.dataset.index);
            });

            document.querySelectorAll('.delete-habit-btn').forEach(btn => {
                btn.onclick = (e) => deleteHabit(e.target.closest('button').dataset.index);
            });
        };

        const updateHabitData = async (index, field, value) => {
            if (!db || !userId) return;
            const docSnap = await getDoc(habitsDocRef());
            const currentHabits = docSnap.data()?.habits || [];
            if (currentHabits[index]) {
                currentHabits[index][field] = value;
                await setDoc(habitsDocRef(), { habits: currentHabits });
            }
        };

        const deleteHabit = async (index) => {
            if (!db || !userId) return;
            const docSnap = await getDoc(habitsDocRef());
            const currentHabits = docSnap.data()?.habits || [];
            currentHabits.splice(index, 1);
            await setDoc(habitsDocRef(), { habits: currentHabits });
        };

        const handleSlip = async (index, currentStreak) => {
            if (!db || !userId) return;
            const docSnap = await getDoc(habitsDocRef());
            const currentHabits = docSnap.data()?.habits || [];
            
            const habit = currentHabits[index];
            habit.lastSlipDate = getTodayDateString();
            if (currentStreak > habit.longestStreak) {
                habit.longestStreak = currentStreak;
            }
            
            await setDoc(habitsDocRef(), { habits: currentHabits });

            const today = getTodayDateString();
            const dailyTrackerDocRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, today);
            const dailyDocSnap = await getDoc(dailyTrackerDocRef);
            if (!dailyDocSnap.exists()) {
                await createTodayDocs();
            }
            const currentSlips = dailyDocSnap.data()?.habitFastSlips || 0;
            await updateDoc(dailyTrackerDocRef, { habitFastSlips: currentSlips + 1 });
        };

        const handleReset = async (index) => {
             if (!db || !userId) return;
            const docSnap = await getDoc(habitsDocRef());
            const currentHabits = docSnap.data()?.habits || [];
            
            const habit = currentHabits[index];
            habit.lastSlipDate = null;
            await setDoc(habitsDocRef(), { habits: currentHabits });
        };

        // Gemini API Functions
        const makeGeminiApiCall = async (prompt) => {
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };
                let response = null;
                const maxRetries = 3;
                let retryCount = 0;

                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status === 429) {
                            const delay = Math.pow(2, retryCount) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue;
                        }
                        break; // Exit loop on successful response
                    } catch (error) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                }
                throw new Error("Invalid API response format.");
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "Failed to get a response. Please try again later.";
            }
        };

        // Daily Reflection feature
        reflectionBtn.addEventListener('click', async () => {
            reflectionBtn.disabled = true;
            reflectionOutput.textContent = 'Generating your reflection...';
            const dailyData = (await getDocs(collection(db, `/artifacts/${appId}/users/${userId}/crusade_data`))).docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const today = getTodayDateString();
            const todayData = dailyData.find(day => day.date === today);
            
            if (!todayData) {
                reflectionOutput.textContent = "Please add today's data first by clicking 'Add Day'.";
                reflectionBtn.disabled = false;
                return;
            }

            const dailyScore = getDailyScore(todayData);
            const prompt = `Based on a daily personal growth score of ${dailyScore} on a scale from 0 to 100+, generate a short, encouraging reflection or a motivational quote for a personal growth tracker app user. Keep it brief and inspiring.`;
            const reflection = await makeGeminiApiCall(prompt);
            reflectionOutput.textContent = reflection;
            reflectionBtn.disabled = false;
        });

        // Weekly Summary feature
        weeklySummaryBtn.addEventListener('click', async () => {
            weeklySummaryBtn.disabled = true;
            weeklySummaryOutput.textContent = 'Generating your weekly summary...';

            // Get last 7 days of data
            const allData = (await getDocs(collection(db, `/artifacts/${appId}/users/${userId}/crusade_data`))).docs.map(doc => doc.data());
            const sortedData = allData.sort((a, b) => a.date.localeCompare(b.date));
            const weeklyData = sortedData.slice(-7);

            if (weeklyData.length === 0) {
                weeklySummaryOutput.textContent = 'No weekly data found. Please log some days to generate a summary.';
                weeklySummaryBtn.disabled = false;
                return;
            }

            const weeklyTotalScore = weeklyData.reduce((sum, day) => sum + (getDailyScore(day) || 0), 0);
            const weeklyJobHours = weeklyData.reduce((sum, day) => sum + (day.jobHours || 0), 0);
            const weeklyImpactHours = weeklyData.reduce((sum, day) => sum + (day.impactHours || 0), 0);
            const growthLevel = getGrowthLevel(weeklyTotalScore);

            const prompt = `
            Analyze the following weekly performance data for a personal growth tracker user:
            - Weekly total score: ${weeklyTotalScore}
            - Current Growth Level: ${growthLevel}
            - Total Job Hours: ${weeklyJobHours.toFixed(2)}
            - Total Impact Hours: ${weeklyImpactHours.toFixed(2)}
            - Daily breakdown: ${JSON.stringify(weeklyData.map(d => ({ date: d.date, score: getDailyScore(d) })))}
            
            Provide a concise, encouraging, and insightful summary of the user's progress for the past week. Highlight key achievements and offer one actionable piece of advice for the next week. Keep it under 100 words.
            `;
            
            const summary = await makeGeminiApiCall(prompt);
            weeklySummaryOutput.textContent = summary;
            weeklySummaryBtn.disabled = false;
        });


        // Explain Growth Level feature
        explainLevelBtn.addEventListener('click', async () => {
            explainLevelBtn.disabled = true;
            levelExplanationOutput.textContent = 'Generating explanation...';
            levelExplanationOutput.classList.remove('hidden');

            const currentLevel = crusadeLevelEl.textContent;
            const prompt = `Explain what "${currentLevel}" means in the context of a personal growth tracker app. Describe the achievements for this level and what the next level might entail. Keep the tone inspiring and concise.`;
            const explanation = await makeGeminiApiCall(prompt);
            levelExplanationOutput.textContent = explanation;
            explainLevelBtn.disabled = false;
        });
        
    });
</script>

</body>
</html>
