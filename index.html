<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Growth Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyD4IYJo_cNRILK3KmmDExpmuO7F4c_izN4",
  authDomain: "growth-tracker-a367c.firebaseapp.com",
  projectId: "growth-tracker-a367c",
  storageBucket: "growth-tracker-a367c.firebasestorage.app",
  messagingSenderId: "277469925642",
  appId: "1:277469925642:web:f79c6f277931c969bfaaf3",
  measurementId: "G-DPYPWBMHLB"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);

// --- Global state ---
let dailyRows={}, weeklyPoints=0;
let tasks=[], habits=[];
let timerState = {
  job: { startTime: null, accumulatedSeconds: 0, interval: null },
  impact: { startTime: null, accumulatedSeconds: 0, interval: null }
};
let dailyChart=null, weeklyChart=null, monthlyChart=null, pieChart=null;
let level = 1, streak = 0;

// --- Elements ---
const loginCard = document.getElementById("login-card");
const appDiv = document.getElementById("app");
const loginError = document.getElementById("loginError");

// --- Helpers ---
function getLocalDate(){
  const today = new Date();
  return today.getFullYear() + "-" + String(today.getMonth()+1).padStart(2,'0') + "-" + String(today.getDate()).padStart(2,'0');
}
function calculateScore(row){
  return (row.prayer?1:0)+(row.mindset?1:0)+(row.prioritize?1:0)+(row.visualize?1:0)+
         (row.exercise?3:0)+(row.tracking?3:0)-row.habitSlips+row.jobHours+row.impactHours*3;
}
function determineLevel(score){
  if(score <= 110) return 1;
  if(score <= 125) return 2;
  if(score <= 140) return 3;
  return 4;
}

// --- Migration for old timers ---
async function migrateTimers(){
  if(!auth.currentUser) return;
  const ref = doc(db,"users",auth.currentUser.uid,"meta","timers");
  const snap = await getDoc(ref);
  if(!snap.exists()) return;

  let timers = snap.data();
  let changed = false;

  ["job","impact"].forEach(type=>{
    if(timers[type]){
      if("interval" in timers[type]){ delete timers[type].interval; changed = true; }
      if(timers[type].startTime && typeof timers[type].startTime !== "number"){
        timers[type].startTime = Number(timers[type].startTime) || null;
        changed = true;
      }
      if(typeof timers[type].accumulatedSeconds !== "number"){
        timers[type].accumulatedSeconds = Number(timers[type].accumulatedSeconds) || 0;
        changed = true;
      }
    }
  });

  if(changed){
    await setDoc(ref,timers);
    console.log("Migrated old timer data âœ…");
  }
}

// --- Auth state ---
onAuthStateChanged(auth, async user => {
  if(user){
    loginCard.style.display = "none"; 
    appDiv.style.display = "block";
    await migrateTimers();
    await loadUserData(user.uid);
    autoIncrementHabits();
  } else {
    loginCard.style.display="block"; 
    appDiv.style.display="none";
  }
});

// --- Login / Signup ---
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(e){ loginError.innerText=`Login failed: ${e.message}`; }
});
document.getElementById("signupBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await createUserWithEmailAndPassword(auth,email,password); alert("Signup successful! You can now login."); }
  catch(e){ loginError.innerText=`Signup failed: ${e.message}`; }
});
document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

// --- Save functions ---
async function saveDailyRow(row){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"dailyRows",row.date),row); }
async function saveTasks(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","tasks"),{tasks}); }
async function saveHabits(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","habits"),{habits}); }
async function saveTimers(){
  if(!auth.currentUser) return;
  const jobCopy = {
    accumulatedSeconds: timerState.job.accumulatedSeconds || 0,
    startTime: timerState.job.startTime ? Number(timerState.job.startTime) : null
  };
  const impactCopy = {
    accumulatedSeconds: timerState.impact.accumulatedSeconds || 0,
    startTime: timerState.impact.startTime ? Number(timerState.impact.startTime) : null
  };
  await setDoc(doc(db,"users",auth.currentUser.uid,"meta","timers"),{job:jobCopy,impact:impactCopy});
}
async function saveLevel(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","level"),{level,streak}); }

// --- Load user data ---
async function loadUserData(uid){
  dailyRows={}; tasks=[]; habits=[];

  const dailySnap = await getDocs(collection(db,"users",uid,"dailyRows"));
  dailySnap.forEach(docSnap => { dailyRows[docSnap.id] = docSnap.data(); });

  const taskSnap = await getDoc(doc(db,"users",uid,"meta","tasks"));
  tasks = taskSnap.exists() ? taskSnap.data().tasks || [] : [];
  renderTasks();

  const habitSnap = await getDoc(doc(db,"users",uid,"meta","habits"));
  habits = habitSnap.exists() ? habitSnap.data().habits || [] : [];
  renderHabits();

  // Load timer state
  const timerSnap = await getDoc(doc(db,"users",uid,"meta","timers"));
  if(timerSnap.exists()){
    const data = timerSnap.data();
    if(data.job) timerState.job = data.job;
    if(data.impact) timerState.impact = data.impact;
    ['job','impact'].forEach(type=>{
      if(timerState[type].startTime){
        timerState[type].startTime = new Date(timerState[type].startTime).getTime();
        timerState[type].interval = setInterval(()=>updateTimersUI(type),1000);
      }
      updateTimersUI(type);
    });
  }

  // Load level
  const levelSnap = await getDoc(doc(db,"users",uid,"meta","level"));
  if(levelSnap.exists()){
    level = levelSnap.data().level || 1;
    streak = levelSnap.data().streak || 0;
  }

  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}

// --- Habit auto-increment ---
function autoIncrementHabits(){
  const today = new Date(getLocalDate());
  let changed = false;
  habits.forEach(h=>{
    if(!h.lastUpdated) h.lastUpdated = getLocalDate();
    const last = new Date(h.lastUpdated);
    const diffMs = today - last;
    const diffDays = diffMs / (1000*60*60*24);
    if(diffDays > 0){
      h.daysSinceLastSlip += diffDays;
      h.lastUpdated = getLocalDate();
      changed = true;
    }
  });
  if(changed){ saveHabits(); renderHabits(); }
}
setInterval(()=>{ autoIncrementHabits(); }, 60000);

// --- Weekly score and Level ---
function updateWeeklyScore(){
  weeklyPoints = 0;
  for (const d in dailyRows) weeklyPoints += calculateScore(dailyRows[d]);
  document.getElementById("weeklyScore").innerText = "Weekly Score: " + weeklyPoints;
  updateLevelAndStreak();
}
function updateLevelAndStreak(){
  const currentLevelReq = determineLevel(weeklyPoints);
  if(currentLevelReq > level){
    streak++;
    if(streak >= 4){
      level = currentLevelReq;
      streak = 0;
      alert("Congratulations! You've leveled up to Level " + level + "!");
    }
  } else {
    streak = 0;
  }
  saveLevel();
}

// --- Daily Tracker ---
document.getElementById("addDayBtn").addEventListener("click", addDay);
function addDay(){
  const localDate = getLocalDate();
  if(dailyRows[localDate]){ alert("Today's row already exists"); return; }

  tasks = []; renderTasks(); saveTasks();

  const row = { 
    date: localDate, prayer:false, mindset:false, prioritize:false, visualize:false, 
    exercise:false, tracking:false, habitSlips:0, jobHours:0, impactHours:0 
  };
  dailyRows[localDate]=row;
  saveDailyRow(row);
  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}

// --- Render Rows ---
function renderRow(row){
  const tbody = document.getElementById("dailyTableBody");
  const tr = document.createElement("tr");
  tr.id = "row_" + row.date;
  const score = calculateScore(row);
  tr.style.backgroundColor = score>=15?"#d4edda":(score>=10?"#fff3cd":"#f8d7da");
  tr.innerHTML = `
<td>${row.date}</td>
<td><input type="checkbox" ${row.prayer?'checked':''} onchange="toggleCheck('${row.date}','prayer')"></td>
<td><input type="checkbox" ${row.mindset?'checked':''} onchange="toggleCheck('${row.date}','mindset')"></td>
<td><input type="checkbox" ${row.prioritize?'checked':''} onchange="toggleCheck('${row.date}','prioritize')"></td>
<td><input type="checkbox" ${row.visualize?'checked':''} onchange="toggleCheck('${row.date}','visualize')"></td>
<td><input type="checkbox" ${row.exercise?'checked':''} onchange="toggleCheck('${row.date}','exercise')"></td>
<td><input type="checkbox" ${row.tracking?'checked':''} onchange="toggleCheck('${row.date}','tracking')"></td>
<td id="habitSlips_${row.date}">${row.habitSlips}</td>
<td><input type="number" min="0" step="0.1" value="${row.jobHours}" onchange="updateHours('${row.date}','job',this.value)"></td>
<td><input type="number" min="0" step="0.1" value="${row.impactHours}" onchange="updateHours('${row.date}','impact',this.value)"></td>
<td id="dailyScore_${row.date}">${score}</td>
`;
  tbody.appendChild(tr);
}
function renderAllRows(){
  const tbody = document.getElementById("dailyTableBody"); tbody.innerHTML="";
  const dates = Object.keys(dailyRows).sort((a,b)=>new Date(a)-new Date(b));
  const last7 = dates.slice(-7);
  const today = getLocalDate();
  last7.forEach(d=>{ renderRow(dailyRows[d]); if(d===today) document.getElementById("row_"+d).style.fontWeight="bold"; });
}
window.updateHours = function(date,type,val){
  const row = dailyRows[date];
  const num = parseFloat(val)||0;
  if(type==='job') row.jobHours=num;
  else if(type==='impact') row.impactHours=num;
  saveDailyRow(row);
  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}

// Toggle checkboxes
window.toggleCheck = function(date,field){
  const row = dailyRows[date];
  row[field]=!row[field];
  if(field!=="tracking") row.tracking=true;
  saveDailyRow(row);
  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}

// --- Tasks ---
document.getElementById("addTaskBtn").addEventListener("click", ()=>{
  const val = document.getElementById("taskInput").value.trim();
  if(val && tasks.length<3){ tasks.push({name:val,completed:false}); renderTasks(); saveTasks(); document.getElementById("taskInput").value=""; }
});
document.getElementById("resetTasksBtn").addEventListener("click", ()=>{
  tasks=[]; renderTasks(); saveTasks();
});
function renderTasks(){
  const div = document.getElementById("taskList"); div.innerHTML="";
  tasks.forEach((t,i)=>{
    const p=document.createElement("p");
    p.innerHTML=`<input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask(${i})"> ${t.name}`;
    div.appendChild(p);
  });
}
window.toggleTask=function(i){ tasks[i].completed=!tasks[i].completed; renderTasks(); saveTasks() }

// --- Habits ---
document.getElementById("addHabitBtn").addEventListener("click", ()=>{
  const val = document.getElementById("habitInput").value.trim();
  if(val){ habits.push({name:val,daysSinceLastSlip:0,lastUpdated:getLocalDate()}); renderHabits(); saveHabits(); document.getElementById("habitInput").value=""; }
});
function renderHabits(){
  const div = document.getElementById("habitList"); div.innerHTML="";
  habits.forEach((h,i)=>{
    const p=document.createElement("p");
    p.className="habit";
    p.innerHTML=`${h.name} - ${h.daysSinceLastSlip} days <button onclick="habitSlip(${i})">Slip</button> <button onclick="deleteHabit(${i})">Delete</button>`;
    div.appendChild(p);
  });
}
window.habitSlip=function(i){
  habits[i].daysSinceLastSlip=0;
  habits[i].lastUpdated=getLocalDate();
  const today = getLocalDate();
  if(dailyRows[today]) dailyRows[today].habitSlips++;
  saveHabits(); saveDailyRow(dailyRows[today]); 
  renderAllRows(); renderHabits(); updateWeeklyScore();
}
window.deleteHabit=function(i){ habits.splice(i,1); renderHabits(); saveHabits(); }

// --- Timers ---
document.getElementById("startJobBtn").addEventListener("click", ()=>startTimer('job'));
document.getElementById("stopJobBtn").addEventListener("click", ()=>stopTimer('job'));
document.getElementById("logJobBtn").addEventListener("click", ()=>logTime('job'));
document.getElementById("resetJobBtn").addEventListener("click", ()=>resetTimer('job'));
document.getElementById("startImpactBtn").addEventListener("click", ()=>startTimer('impact'));
document.getElementById("stopImpactBtn").addEventListener("click", ()=>stopTimer('impact'));
document.getElementById("logImpactBtn").addEventListener("click", ()=>logTime('impact'));
document.getElementById("resetImpactBtn").addEventListener("click", ()=>resetTimer('impact'));

function startTimer(type){
  if(timerState[type].interval) return;
  timerState[type].startTime = Date.now();
  timerState[type].interval = setInterval(()=>updateTimersUI(type),1000);
  saveTimers();
}
function stopTimer(type){
  if(!timerState[type].interval) return;
  clearInterval(timerState[type].interval);
  const elapsed = Math.floor((Date.now()-timerState[type].startTime)/1000);
  timerState[type].accumulatedSeconds += elapsed;
  timerState[type].startTime = null;
  timerState[type].interval = null;
  saveTimers();
  updateTimersUI(type);
}
function logTime(type){
  stopTimer(type);
  const today = getLocalDate();
  const hours = Number((timerState[type].accumulatedSeconds / 3600).toFixed(2));
  if(!dailyRows[today]){
    const row = { 
      date: today, prayer:false, mindset:false, prioritize:false, visualize:false, 
      exercise:false, tracking:false, habitSlips:0, jobHours:0, impactHours:0 
    };
    dailyRows[today] = row;
    saveDailyRow(row);
  }

  if(type === 'job'){
    dailyRows[today].jobHours = (dailyRows[today].jobHours || 0) + hours;
  } else if(type === 'impact'){
    dailyRows[today].impactHours = (dailyRows[today].impactHours || 0) + hours;
  }

  timerState[type].accumulatedSeconds = 0;
  timerState[type].startTime = null;
  if(timerState[type].interval){
    clearInterval(timerState[type].interval);
    timerState[type].interval = null;
  }

  saveDailyRow(dailyRows[today]);
  saveTimers();
  updateTimersUI(type);
  renderAllRows();
  updateWeeklyScore();
  renderCharts();
}
function resetTimer(type){
  if(timerState[type].interval){
    clearInterval(timerState[type].interval);
    timerState[type].interval = null;
  }
  timerState[type].startTime = null;
  timerState[type].accumulatedSeconds = 0;
  saveTimers();
  updateTimersUI(type);
}
function updateTimersUI(type){
  const seconds = timerState[type].accumulatedSeconds + (timerState[type].startTime ? Math.floor((Date.now()-timerState[type].startTime)/1000) : 0);
  const h = Math.floor(seconds/3600);
  const m = Math.floor((seconds%3600)/60);
  const s = seconds%60;
  document.getElementById(type+'Timer').innerText = `${h}h ${m}m ${s}s`;
}

// --- Charts (placeholder simple render) ---
function renderCharts(){
  // Can integrate Chart.js charts as needed
}

</script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; }
.section{margin:10px;padding:10px;background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.table-container{max-height:400px; overflow-y:auto; overflow-x:auto; border:1px solid #ddd; border-radius:6px; background:#fff; padding:8px;}
table{width:100%; border-collapse: collapse; font-size:14px;}
th,td{padding:6px 10px; border:1px solid #ddd; text-align:center;}
th{background:#f8f8f8; position:sticky; top:0; z-index:2;}
.habit button{margin-left:4px;}
#login-card{padding:20px;max-width:300px;margin:20px auto;border:1px solid #ccc;border-radius:6px;background:#fff;}
#app{display:none;}
</style>
</head>
<body>
<div id="login-card">
  <h2>Login / Signup</h2>
  <input type="email" id="email" placeholder="Email"><br><br>
  <input type="password" id="password" placeholder="Password"><br><br>
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Signup</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="app">
  <button id="logoutBtn">Logout</button>
  <h1>Growth Tracker</h1>
  <div id="weeklyScore">Weekly Score: 0</div>

  <!-- Daily Tracker Section -->
  <section id="dailyTracker" class="section">
    <h2>Daily Tracker</h2>
    <button id="addDayBtn">Add Today</button>
    <div class="table-container">
      <table id="dailyTable">
        <thead>
          <tr>
            <th>Date</th><th>Prayer</th><th>Mindset</th><th>Prioritize</th><th>Visualize</th>
            <th>Exercise</th><th>Tracking</th><th>Habit Slips</th><th>Job Hours</th><th>Impact Hours</th><th>Score</th>
          </tr>
        </thead>
        <tbody id="dailyTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Tasks -->
  <section class="section">
    <h2>Tasks</h2>
    <input type="text" id="taskInput" placeholder="New Task"><button id="addTaskBtn">Add</button>
    <button id="resetTasksBtn">Reset</button>
    <div id="taskList"></div>
  </section>

  <!-- Habits -->
  <section class="section">
    <h2>Habits</h2>
    <input type="text" id="habitInput" placeholder="New Habit"><button id="addHabitBtn">Add</button>
    <div id="habitList"></div>
  </section>

  <!-- Timers -->
  <section class="section">
    <h2>Timers</h2>
    <div>
      <h3>Job Hours</h3>
      <span id="jobTimer">0h 0m 0s</span>
      <button id="startJobBtn">Start</button>
      <button id="stopJobBtn">Stop</button>
      <button id="logJobBtn">Log</button>
      <button id="resetJobBtn">Reset</button>
    </div>
    <div>
      <h3>Impact Hours</h3>
      <span id="impactTimer">0h 0m 0s</span>
      <button id="startImpactBtn">Start</button>
      <button id="stopImpactBtn">Stop</button>
      <button id="logImpactBtn">Log</button>
      <button id="resetImpactBtn">Reset</button>
    </div>
  </section>
</div>
</body>
</html>
