<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Growth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 6px 8px -3px rgba(0, 0, 0, 0.05);
        }
        input[type="number"] {
            -moz-appearance: textfield;
            text-align: center;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Custom styles for loading indicator */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">Personal Growth Tracker</h1>
        
        <!-- Daily Tracker Section -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Daily Tracker</h2>
            <div id="tracker-table-container" class="overflow-x-auto">
                <!-- Table will be generated here by JavaScript -->
            </div>
            <div class="mt-4 text-center">
                <button id="add-day-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 active:scale-95 transition duration-300">Add Day</button>
            </div>
        </div>

        <!-- Prioritization Checklist Section -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-2 text-center">Prioritization Checklist</h2>
            <div id="prioritization-list" class="space-y-4">
                <!-- Prioritization items will be generated here -->
            </div>
            <div class="flex justify-center mt-4">
                <input type="text" id="new-priority-input" placeholder="Add a new task..." class="p-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 flex-1">
                <button id="add-priority-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-indigo-600 active:scale-95 transition duration-300">Add</button>
            </div>
        </div>
        
        <!-- Job Hours and Impact Hours Timers -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Timers</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <!-- Job Hours Timer -->
                <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Job Hours</h3>
                    <p id="job-timer-display" class="text-3xl font-mono text-gray-800 mb-4">00:00:00</p>
                    <div class="flex justify-center space-x-4">
                        <button id="job-start-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 active:scale-95 transition duration-300">Start</button>
                        <button id="job-stop-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 active:scale-95 transition duration-300">Stop</button>
                        <button id="job-log-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 active:scale-95 transition duration-300">Log</button>
                    </div>
                </div>

                <!-- Impact Hours Timer -->
                <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Impact Hours</h3>
                    <p id="impact-timer-display" class="text-3xl font-mono text-gray-800 mb-4">00:00:00</p>
                    <div class="flex justify-center space-x-4">
                        <button id="impact-start-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 active:scale-95 transition duration-300">Start</button>
                        <button id="impact-stop-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 active:scale-95 transition duration-300">Stop</button>
                        <button id="impact-log-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 active:scale-95 transition duration-300">Log</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Habit Breaking Section -->
        <div class="card mt-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700 text-center">Habit Breaking</h2>
                <button id="add-habit-btn" class="bg-green-500 text-white text-sm font-bold py-1 px-3 rounded-lg hover:bg-green-600 active:scale-95 transition duration-300">Add Habit</button>
            </div>
            <div id="habit-breaking-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Habits will be dynamically added here -->
            </div>
        </div>

        <!-- Weekly Total, Growth Level, and Level Up Streak -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 mb-6">
            <div class="card text-center">
                <h2 class="text-lg font-bold text-gray-700 mb-2">Weekly Total</h2>
                <p id="weekly-total" class="text-4xl font-extrabold text-indigo-600">0</p>
            </div>
            <div class="card text-center">
                <h2 class="text-lg font-bold text-gray-700 mb-2">Growth Level <button id="explain-level-btn" class="text-sm text-indigo-500 hover:text-indigo-700 font-normal active:scale-95 transition duration-300">What's this? ✨</button></h2>
                <p id="crusade-level" class="text-2xl font-bold text-teal-600">Below Growth Level One</p>
                <p id="level-explanation" class="text-xs text-gray-500 mt-2 italic hidden"></p>
            </div>
            <div class="card text-center">
                <h2 class="text-lg font-bold text-gray-700 mb-2">Level Up Streak</h2>
                <p id="level-streak" class="text-4xl font-extrabold text-blue-600">0</p>
            </div>
        </div>
        
        <!-- Progress Chart Section -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-2 text-center">Progress Chart</h2>
            <div class="mx-auto max-w-xl">
                <canvas id="progressChart" class="bg-gray-50 rounded-lg p-2"></canvas>
            </div>
        </div>

        <!-- Daily Reflection and Weekly Summary Section -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Insights</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Daily Reflection</h3>
                    <button id="reflection-btn" class="w-full bg-purple-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-600 active:scale-95 transition duration-300">Generate ✨</button>
                    <p id="reflection-output" class="mt-4 text-gray-700 italic text-sm"></p>
                </div>
                <div class="text-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">Weekly Summary</h3>
                    <button id="weekly-summary-btn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 active:scale-95 transition duration-300">Generate ✨</button>
                    <p id="weekly-summary-output" class="mt-4 text-gray-700 italic text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Impact Hours Explanation Section -->
        <div class="card mt-6 mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-2 text-center">What Are Impact Hours?</h2>
            <p class="text-gray-700 mb-2">Impact hours are focused, high-leverage activities that contribute directly to your personal and professional growth. They are designed to move you closer to your long-term goals. Examples include:</p>
            <ul class="list-disc list-inside space-y-1 text-gray-700">
                <li>Studying valuable skills</li>
                <li>Practicing your craft</li>
                <li>Designing a product</li>
                <li>Focused work on your mission</li>
                <li>Recording content</li>
                <li>Building your business</li>
            </ul>
        </div>

        <div class="mt-6 text-center text-gray-600 text-sm">
            <p id="user-id-display" class="font-mono break-all"></p>
        </div>
    </div>
    <div id="loading-spinner" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden">
        <div class="loader"></div>
    </div>
    <div id="custom-popup" class="popup">
        <p id="popup-message" class="text-center"></p>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let db;
    let auth;
    let userId;
    let myChart = null; // Store the Chart.js instance

    // Function to show a custom popup message instead of alert()
    const showPopup = (message, duration = 3000) => {
        const popup = document.getElementById('custom-popup');
        const popupMessage = document.getElementById('popup-message');
        popupMessage.textContent = message;
        popup.style.display = 'block';
        setTimeout(() => {
            popup.style.display = 'none';
        }, duration);
    };

    const showLoader = () => {
        document.getElementById('loading-spinner').style.display = 'block';
    };

    const hideLoader = () => {
        document.getElementById('loading-spinner').style.display = 'none';
    };
    
    // --- Habit Breaking Logic ---
    const habitsDocRef = () => doc(db, `/artifacts/${appId}/users/${userId}/habit_breaking`, 'habits');

    const addHabit = async () => {
        try {
            if (!db || !userId) {
                console.error("Database or user not ready.");
                showPopup("App not ready. Please wait a moment.");
                return;
            }
            const newHabitName = await new Promise(resolve => {
                const message = "Enter the habit you want to break (e.g., 'eating junk food'):";
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = "New Habit";
                input.className = "w-full p-2 mt-2 text-black rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500";
                const container = document.createElement('div');
                container.className = "fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 p-8 rounded-lg shadow-lg z-50 flex flex-col items-center";
                const textNode = document.createElement('p');
                textNode.textContent = message;
                textNode.className = "text-white text-lg mb-4 text-center";
                const buttonContainer = document.createElement('div');
                buttonContainer.className = "flex space-x-4 mt-4";
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirm';
                confirmBtn.className = "bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 active:scale-95 transition duration-300";
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = "bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 active:scale-95 transition duration-300";

                confirmBtn.onclick = () => {
                    document.body.removeChild(container);
                    resolve(input.value);
                };
                cancelBtn.onclick = () => {
                    document.body.removeChild(container);
                    resolve(null);
                };
                
                container.appendChild(textNode);
                container.appendChild(input);
                buttonContainer.appendChild(confirmBtn);
                buttonContainer.appendChild(cancelBtn);
                container.appendChild(buttonContainer);
                document.body.appendChild(container);
                input.focus();
            });

            if (newHabitName === null || newHabitName.trim() === '') {
                showPopup("Habit creation cancelled.");
                return;
            }

            const docSnap = await getDoc(habitsDocRef());
            const currentHabits = docSnap.data()?.habits || [];
            currentHabits.push({ name: newHabitName.trim(), lastSlipDate: null, longestStreak: 0 });
            await setDoc(habitsDocRef(), { habits: currentHabits });
            showPopup("New habit added successfully!");
        } catch (error) {
            console.error("Error adding new habit:", error);
            showPopup("Error adding habit. Check console.");
        }
    };

    const renderHabitBreakingSection = (habits) => {
        const container = document.getElementById('habit-breaking-container');
        container.innerHTML = '';
        if (habits.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 col-span-1 md:col-span-2">No habits tracked yet. Click 'Add Habit' to begin.</p>`;
            return;
        }

        habits.forEach((habit, index) => {
            const today = getTodayDateString();
            const lastSlipDate = habit.lastSlipDate ? new Date(habit.lastSlipDate.toDate()).toISOString().split('T')[0] : null;
            const streak = lastSlipDate ? Math.floor((new Date(today) - new Date(lastSlipDate)) / (1000 * 60 * 60 * 24)) : '∞';

            const habitCard = document.createElement('div');
            habitCard.className = "card";
            habitCard.innerHTML = `
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-bold text-gray-700 mb-2 text-center">${habit.name}</h3>
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="text-sm text-gray-600">Streak:</span>
                        <span class="text-lg font-extrabold text-teal-500">${streak} days</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">Last slip: ${lastSlipDate || 'Never'}</p>
                    <button class="slip-btn bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 active:scale-95 transition duration-300" data-index="${index}">I Slipped</button>
                </div>
            `;
            container.appendChild(habitCard);
        });

        container.querySelectorAll('.slip-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const index = parseInt(e.target.dataset.index, 10);
                const docSnap = await getDoc(habitsDocRef());
                const currentHabits = docSnap.data()?.habits || [];
                const slippedHabit = currentHabits[index];
                
                if (slippedHabit) {
                    const today = getTodayDateString();
                    // Increment the daily habit slip counter
                    const crusadeDocRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, today);
                    const docSnap = await getDoc(crusadeDocRef);
                    const currentData = docSnap.data();
                    const currentSlips = currentData?.habitFastSlips || 0;
                    await setDoc(crusadeDocRef, { habitFastSlips: currentSlips + 1 }, { merge: true });

                    // Update the lastSlipDate for the habit
                    slippedHabit.lastSlipDate = new Date();
                    await setDoc(habitsDocRef(), { habits: currentHabits });
                    showPopup(`Logged a slip for "${slippedHabit.name}".`);
                }
            });
        });
    };

    // --- Prioritization Logic ---
    const priorityDocRef = () => doc(db, `/artifacts/${appId}/users/${userId}/priorities`, getTodayDateString());

    const addPriority = async (task) => {
        if (!task || task.trim() === '') return;
        try {
            const docSnap = await getDoc(priorityDocRef());
            const currentTasks = docSnap.data()?.tasks || [];
            currentTasks.push({ id: Date.now(), text: task, completed: false });
            await setDoc(priorityDocRef(), { tasks: currentTasks }, { merge: true });
        } catch (error) {
            console.error("Error adding priority task:", error);
        }
    };

    const renderPriorities = (tasks) => {
        const container = document.getElementById('prioritization-list');
        container.innerHTML = '';
        if (tasks.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500">No tasks for today. Add a high-leverage task to your list!</p>';
        }
        tasks.forEach(task => {
            const taskEl = document.createElement('div');
            taskEl.className = "flex items-center p-3 bg-gray-50 rounded-lg";
            taskEl.innerHTML = `
                <input type="checkbox" class="task-checkbox accent-indigo-500 h-5 w-5 mr-4 cursor-pointer" ${task.completed ? 'checked' : ''} data-id="${task.id}">
                <span class="flex-1 text-gray-800 text-sm md:text-base ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</span>
                <button class="delete-btn text-red-500 hover:text-red-700 ml-4 font-bold active:scale-95 transition duration-300" data-id="${task.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            container.appendChild(taskEl);
        });

        container.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', async (e) => {
                const taskId = parseInt(e.target.dataset.id, 10);
                const docSnap = await getDoc(priorityDocRef());
                const currentTasks = docSnap.data()?.tasks || [];
                const updatedTasks = currentTasks.map(task => {
                    if (task.id === taskId) {
                        return { ...task, completed: e.target.checked };
                    }
                    return task;
                });
                await setDoc(priorityDocRef(), { tasks: updatedTasks });
            });
        });

        container.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const taskId = parseInt(e.currentTarget.dataset.id, 10);
                const docSnap = await getDoc(priorityDocRef());
                const currentTasks = docSnap.data()?.tasks || [];
                const updatedTasks = currentTasks.filter(task => task.id !== taskId);
                await setDoc(priorityDocRef(), { tasks: updatedTasks });
            });
        });
    };

    document.addEventListener('DOMContentLoaded', async () => {
        const trackerTableContainer = document.getElementById('tracker-table-container');
        const addDayBtn = document.getElementById('add-day-btn');
        const weeklyTotalEl = document.getElementById('weekly-total');
        const crusadeLevelEl = document.getElementById('crusade-level');
        const levelStreakEl = document.getElementById('level-streak');
        const userIdDisplay = document.getElementById('user-id-display');
        const explainLevelBtn = document.getElementById('explain-level-btn');
        const levelExplanationOutput = document.getElementById('level-explanation');
        const reflectionBtn = document.getElementById('reflection-btn');
        const reflectionOutput = document.getElementById('reflection-output');
        const weeklySummaryBtn = document.getElementById('weekly-summary-btn');
        const weeklySummaryOutput = document.getElementById('weekly-summary-output');
        const prioritizationList = document.getElementById('prioritization-list');
        const progressChartEl = document.getElementById('progressChart');
        const habitBreakingContainer = document.getElementById('habit-breaking-container');
        const addHabitBtn = document.getElementById('add-habit-btn');
        const newPriorityInput = document.getElementById('new-priority-input');
        const addPriorityBtn = document.getElementById('add-priority-btn');

        // Timer elements
        const jobTimerDisplay = document.getElementById('job-timer-display');
        const jobStartBtn = document.getElementById('job-start-btn');
        const jobStopBtn = document.getElementById('job-stop-btn');
        const jobLogBtn = document.getElementById('job-log-btn');
        const impactTimerDisplay = document.getElementById('impact-timer-display');
        const impactStartBtn = document.getElementById('impact-start-btn');
        const impactStopBtn = document.getElementById('impact-stop-btn');
        const impactLogBtn = document.getElementById('impact-log-btn');

        // Timer state for both timers, now stored in local storage for a better user experience
        let jobTimer = {
            intervalId: null,
            startTime: 0,
            elapsedTime: 0
        };
        let impactTimer = {
            intervalId: null,
            startTime: 0,
            elapsedTime: 0
        };

        const updateTimerDisplay = (time, displayElement) => {
            const hours = Math.floor(time / 3600);
            const minutes = Math.floor((time % 3600) / 60);
            const seconds = Math.floor(time % 60);
            const formattedTime = [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                seconds.toString().padStart(2, '0')
            ].join(':');
            displayElement.textContent = formattedTime;
        };

        const startTimer = (timer, displayElement, key) => {
            if (timer.intervalId) return;
            timer.startTime = Date.now() - timer.elapsedTime;
            timer.intervalId = setInterval(() => {
                timer.elapsedTime = Math.floor((Date.now() - timer.startTime) / 1000);
                updateTimerDisplay(timer.elapsedTime, displayElement);
            }, 1000);
            localStorage.setItem(`${key}IsRunning`, 'true');
        };

        const stopTimer = (timer, key) => {
            clearInterval(timer.intervalId);
            timer.intervalId = null;
            localStorage.removeItem(`${key}IsRunning`);
        };

        const logTimer = async (timer, key) => {
            stopTimer(timer, key);
            const hours = timer.elapsedTime / 3600;
            const today = getTodayDateString();
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, today);
            
            try {
                // Ensure the document exists before attempting to update it
                await setDoc(docRef, {}, { merge: true });
                await updateDoc(docRef, { [key + 'Hours']: Math.round(hours * 100) / 100 });
                showPopup(`${key.charAt(0).toUpperCase() + key.slice(1)} hours logged: ${hours.toFixed(2)}.`);
            } catch (error) {
                console.error("Error logging hours:", error);
                showPopup("Error logging hours. Check console.");
            }
            timer.elapsedTime = 0;
            timer.startTime = 0;
            updateTimerDisplay(0, document.getElementById(`${key}-timer-display`));
            localStorage.removeItem(`${key}TimerState`);
        };
        
        // Timer event listeners
        jobStartBtn.addEventListener('click', () => startTimer(jobTimer, jobTimerDisplay, 'job'));
        jobStopBtn.addEventListener('click', () => stopTimer(jobTimer, 'job'));
        jobLogBtn.addEventListener('click', () => logTimer(jobTimer, 'job'));
        impactStartBtn.addEventListener('click', () => startTimer(impactTimer, impactTimerDisplay, 'impact'));
        impactStopBtn.addEventListener('click', () => stopTimer(impactTimer, 'impact'));
        impactLogBtn.addEventListener('click', () => logTimer(impactTimer, 'impact'));

        // Load timer state on page load
        const loadTimerState = () => {
            const storedJobState = localStorage.getItem('jobTimerState');
            if (storedJobState) {
                const state = JSON.parse(storedJobState);
                jobTimer.elapsedTime = state.elapsedTime || 0;
                jobTimer.startTime = state.startTime || 0;
                if (localStorage.getItem('jobIsRunning')) {
                    startTimer(jobTimer, jobTimerDisplay, 'job');
                } else {
                    updateTimerDisplay(jobTimer.elapsedTime, jobTimerDisplay);
                }
            }
            const storedImpactState = localStorage.getItem('impactTimerState');
            if (storedImpactState) {
                const state = JSON.parse(storedImpactState);
                impactTimer.elapsedTime = state.elapsedTime || 0;
                impactTimer.startTime = state.startTime || 0;
                if (localStorage.getItem('impactIsRunning')) {
                    startTimer(impactTimer, impactTimerDisplay, 'impact');
                } else {
                    updateTimerDisplay(impactTimer.elapsedTime, impactTimerDisplay);
                }
            }
        };

        const saveTimerState = () => {
            localStorage.setItem('jobTimerState', JSON.stringify({
                elapsedTime: jobTimer.elapsedTime,
                startTime: jobTimer.startTime
            }));
            localStorage.setItem('impactTimerState', JSON.stringify({
                elapsedTime: impactTimer.elapsedTime,
                startTime: impactTimer.startTime
            }));
        };

        window.addEventListener('beforeunload', saveTimerState);
        loadTimerState();

        // LLM generation functions with retries
        const generateContentWithRetry = async (prompt, systemPrompt, maxRetries = 3) => {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API call failed: ${response.status} - ${JSON.stringify(errorData)}`);
                    }
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("API response is empty or malformed.");
                    return text;
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                    attempt++;
                }
            }
        };

        const generateReflection = async () => {
            showLoader();
            reflectionOutput.textContent = '';
            try {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, getTodayDateString());
                const docSnap = await getDoc(docRef);
                const dailyData = docSnap.data();

                if (!dailyData || Object.keys(dailyData).length === 0) {
                    throw new Error("No data found for today's reflection.");
                }

                const prompt = `Based on the following personal growth data for today, provide a brief, insightful, and motivating reflection. Focus on key achievements and areas for improvement. Data: ${JSON.stringify(dailyData)}`;
                const systemPrompt = "You are a personal growth coach. Provide a concise, single-paragraph reflection (under 100 words) to help the user reflect on their day and stay motivated.";
                const reflectionText = await generateContentWithRetry(prompt, systemPrompt);
                reflectionOutput.textContent = reflectionText;
            } catch (error) {
                console.error("Error generating daily reflection:", error);
                reflectionOutput.textContent = "Could not generate a reflection. Please check your data and try again.";
            } finally {
                hideLoader();
            }
        };
        
        const generateWeeklySummary = async () => {
            showLoader();
            weeklySummaryOutput.textContent = '';
            try {
                const crusadeCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/crusade_data`);
                const querySnapshot = await getDocs(crusadeCollectionRef);
                const allData = querySnapshot.docs.map(doc => doc.data());
                const last7DaysData = allData.slice(-7);

                if (last7DaysData.length === 0) {
                    throw new Error("No data found for weekly summary.");
                }

                const prompt = `Based on the following personal growth data from the last 7 days, provide a brief, encouraging, and analytical weekly summary. Highlight overall progress, identify trends (positive or negative), and offer a single piece of actionable advice for the next week. Data: ${JSON.stringify(last7DaysData)}`;
                const systemPrompt = "You are a personal growth coach. Provide a concise, single-paragraph weekly summary (under 150 words) that is both analytical and highly motivating. Highlight key trends and provide actionable advice.";
                const summaryText = await generateContentWithRetry(prompt, systemPrompt);
                weeklySummaryOutput.textContent = summaryText;
            } catch (error) {
                console.error("Error generating weekly summary:", error);
                weeklySummaryOutput.textContent = "Could not generate a weekly summary. Please check your data and try again.";
            } finally {
                hideLoader();
            }
        };

        const getDailyScore = (day) => {
            let score = 0;
            score += (day.prayer || 0);
            score += (day.mindsetWork || 0);
            score += (day.prioritize || 0);
            score += (day.exercise || 0) * 3;
            score += (day.visualize || 0);
            score += (day.tracking || 0) * 3;
            score -= (day.habitFastSlips || 0);
            score += (day.jobHours || 0);
            score += (day.impactHours || 0) * 3;
            return score;
        };

        const renderTable = (data) => {
            trackerTableContainer.innerHTML = '';
            if (data.length === 0) {
                trackerTableContainer.innerHTML = '<p class="text-center text-gray-500">No data to display. Click "Add Day" to begin.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = "min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden";
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Prayer (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Mindset Work (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Prioritize (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Visualize (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Exercise (+3)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Tracking (+3)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Habit Slips (-1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Job Hours (+1)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Impact Hours (+3)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Daily Score</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                </tbody>
            `;
            const tbody = table.querySelector('tbody');

            data.sort((a, b) => a.date.localeCompare(b.date));

            data.forEach((day, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                // Fix: Manually format the date to avoid timezone issues with `new Date()`
                const [year, month, dateDay] = day.date.split('-');
                const formattedDate = `${month}/${dateDay}`;

                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${formattedDate}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="prayer" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.prayer ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="mindsetWork" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.mindsetWork ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="prioritize" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.prioritize ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="visualize" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.visualize ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="exercise" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.exercise ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-field="tracking" class="accent-indigo-600 rounded-sm w-4 h-4" ${day.tracking ? 'checked' : ''} disabled>
                    </td>
                    <td class="px-4 py-2 whitespace-now-wrap text-sm text-center">
                        <!-- Habit slips are now automatically updated by the new section -->
                        <input type="number" data-field="habitFastSlips" value="${day.habitFastSlips || 0}" class="w-12 text-center border rounded-md" disabled>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="number" data-field="jobHours" value="${day.jobHours || 0}" class="w-12 text-center border rounded-md" disabled>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center">
                        <input type="number" data-field="impactHours" value="${day.impactHours || 0}" class="w-12 text-center border rounded-md" disabled>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-bold text-gray-900 text-center">${getDailyScore(day)}</td>
                `;

                const coreCheckboxes = row.querySelectorAll('input[type="checkbox"]:not([data-field="tracking"])');

                // Listener for updating the tracking status and other fields
                coreCheckboxes.forEach(input => {
                    input.addEventListener('change', async () => {
                        const field = input.dataset.field;
                        let value = input.checked ? 1 : 0;
                        const docRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, day.id);
                        
                        await setDoc(docRef, { [field]: value }, { merge: true }).catch(console.error);

                        // Check if at least one core checkbox is checked to update 'tracking'
                        const updatedData = (await getDoc(docRef)).data();
                        const trackingValue = (updatedData.prayer || updatedData.mindsetWork || updatedData.prioritize || updatedData.visualize || updatedData.exercise) ? 1 : 0;
                        await updateDoc(docRef, { tracking: trackingValue });
                    });
                });

                row.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const field = e.target.dataset.field;
                        const value = parseInt(e.target.value, 10) || 0;
                        const docRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, day.id);
                        setDoc(docRef, { [field]: value }, { merge: true }).catch(console.error);
                    });
                });

                tbody.appendChild(row);
            });
            trackerTableContainer.appendChild(table);
        };

        const updateDashboard = (data) => {
            const dailyScores = data.slice(-7).map(day => getDailyScore(day));
            const weeklyTotal = dailyScores.reduce((sum, score) => sum + score, 0);
            weeklyTotalEl.textContent = weeklyTotal;
            crusadeLevelEl.textContent = getGrowthLevel(weeklyTotal);
            levelStreakEl.textContent = getLevelStreak(weeklyTotal);
        };

        // --- Chart.js Logic ---
        const renderProgressChart = (data) => {
            const sortedData = data.sort((a, b) => a.date.localeCompare(b.date));
            const last30DaysData = sortedData.slice(-30);
            const labels = last30DaysData.map(day => {
                const [, month, dayOfMonth] = day.date.split('-');
                return `${month}/${dayOfMonth}`;
            });
            const scores = last30DaysData.map(day => getDailyScore(day));

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Daily Score',
                    data: scores,
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Score',
                            color: '#4b5563'
                        },
                        ticks: {
                            color: '#4b5563'
                        },
                        grid: {
                            color: 'rgba(209, 213, 219, 0.5)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            color: '#4b5563'
                        },
                        ticks: {
                            color: '#4b5563'
                        },
                        grid: {
                            color: 'rgba(209, 213, 219, 0.5)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                }
            };

            if (myChart) {
                myChart.data = chartData;
                myChart.update();
            } else {
                myChart = new Chart(progressChartEl, {
                    type: 'line',
                    data: chartData,
                    options: chartOptions
                });
            }
        };

        const getGrowthLevel = (score) => {
            if (score >= 141) return "Growth Level Four";
            if (score >= 126) return "Growth Level Three";
            if (score >= 112) return "Growth Level Two";
            if (score >= 99) return "Growth Level One";
            return "Below Growth Level One";
        };

        const getLevelStreak = (score) => {
            const storedStreak = localStorage.getItem('levelStreak');
            const streak = storedStreak ? parseInt(storedStreak, 10) : 0;
            const currentLevel = getGrowthLevel(score);
            if (currentLevel === localStorage.getItem('lastLevel')) {
                if (currentLevel !== "Below Growth Level One" && score >= getLevelPoints(currentLevel)) {
                    const newStreak = streak + 1;
                    localStorage.setItem('levelStreak', newStreak);
                    localStorage.setItem('lastLevel', currentLevel);
                    return newStreak;
                } else {
                    return streak;
                }
            } else {
                localStorage.setItem('levelStreak', 0);
                localStorage.setItem('lastLevel', currentLevel);
                return 0;
            }
        };

        const getLevelPoints = (level) => {
            switch (level) {
                case "Growth Level One": return 99;
                case "Growth Level Two": return 112;
                case "Growth Level Three": return 126;
                case "Growth Level Four": return 141;
                default: return 0;
            }
        };

        // Helper function to get the current date string in YYYY-MM-DD format
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // Function to create a new day and priorities docs if they don't exist
        const createTodayDocs = async () => {
            if (!db || !userId) {
                console.error("Database or user not ready.");
                return;
            }
            const today = getTodayDateString();
            const crusadeDocRef = doc(db, `/artifacts/${appId}/users/${userId}/crusade_data`, today);
            const priorityDocRef = doc(db, `/artifacts/${appId}/users/${userId}/priorities`, today);
            
            try {
                const crusadeDocSnap = await getDoc(crusadeDocRef);
                if (!crusadeDocSnap.exists()) {
                    await setDoc(crusadeDocRef, {
                        date: today,
                        prayer: 0,
                        mindsetWork: 0,
                        prioritize: 0,
                        visualize: 0,
                        exercise: 0,
                        tracking: 0,
                        habitFastSlips: 0,
                        jobHours: 0,
                        impactHours: 0
                    });
                    console.log("New day document created for today.");
                }

                const priorityDocSnap = await getDoc(priorityDocRef);
                if (!priorityDocSnap.exists()) {
                    await setDoc(priorityDocRef, { tasks: [] });
                    console.log("New priority document created for today.");
                }
            } catch (error) {
                console.error("Error creating today's documents:", error);
            }
        };

        // Main event listeners
        addDayBtn.addEventListener('click', async () => {
            await createTodayDocs();
            showPopup("New day created! Please refresh the page.");
        });

        explainLevelBtn.addEventListener('click', () => {
            const explanationText = "Your Growth Level is based on your total weekly score. Level One is 99 points, and each level up requires a higher score. A Level Up Streak is achieved by reaching a new level for consecutive weeks.";
            levelExplanationOutput.textContent = explanationText;
            levelExplanationOutput.classList.toggle('hidden');
        });

        addPriorityBtn.addEventListener('click', () => {
            addPriority(newPriorityInput.value);
            newPriorityInput.value = '';
        });
        
        reflectionBtn.addEventListener('click', generateReflection);
        weeklySummaryBtn.addEventListener('click', generateWeeklySummary);
        addHabitBtn.addEventListener('click', addHabit);
        
        // --- Firebase Initialization and Authentication ---
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;
                console.log("Firebase initialized and user authenticated:", userId);

                // IMPORTANT: Call this function on auth state change to ensure docs are always present
                await createTodayDocs();
                
                // Once authenticated, start listening to Firestore data
                const crusadeCollection = collection(db, `/artifacts/${appId}/users/${userId}/crusade_data`);
                onSnapshot(crusadeCollection, (snapshot) => {
                    const dailyData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderTable(dailyData);
                    updateDashboard(dailyData);
                    renderProgressChart(dailyData);
                }, (error) => {
                    console.error("Error listening to Firestore changes:", error);
                });

                // Listen for priority data
                const today = getTodayDateString();
                const priorityDocRef = doc(db, `/artifacts/${appId}/users/${userId}/priorities`, today);
                onSnapshot(priorityDocRef, (docSnapshot) => {
                    const data = docSnapshot.data()?.tasks || [];
                    renderPriorities(data);
                }, (error) => {
                    console.error("Error listening to priority data:", error);
                });

                // Listen for habit breaking data
                const habitsDocRef = doc(db, `/artifacts/${appId}/users/${userId}/habit_breaking`, 'habits');
                onSnapshot(habitsDocRef, (docSnapshot) => {
                    const data = docSnapshot.data() || {
                        habits: []
                    };
                    renderHabitBreakingSection(data.habits);
                }, (error) => {
                    console.error("Error listening to habit breaking data:", error);
                });

            } else {
                console.log("No user signed in. Signing in anonymously...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    userIdDisplay.textContent = "Authentication failed. Please try again.";
                }
            }
        });
    });
</script>
</body>
</html>
