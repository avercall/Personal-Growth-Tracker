<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Growth Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyD4IYJo_cNRILK3KmmDExpmuO7F4c_izN4",
  authDomain: "growth-tracker-a367c.firebaseapp.com",
  projectId: "growth-tracker-a367c",
  storageBucket: "growth-tracker-a367c.firebasestorage.app",
  messagingSenderId: "277469925642",
  appId: "1:277469925642:web:f79c6f277931c969bfaaf3",
  measurementId: "G-DPYPWBMHLB"
};
const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);

// --- Global state ---
let dailyRows={}, tasks=[], habits=[], jobSeconds=0, impactSeconds=0;
let jobInterval=null, impactInterval=null;
let dailyChart=null, weeklyChart=null, monthlyChart=null, pieChart=null;
let weeklyPoints=0, currentLevel=1, streak=0;

// --- Elements ---
const loginCard = document.getElementById("login-card");
const appDiv = document.getElementById("app");
const loginError = document.getElementById("loginError");
const weeklyFeedback = document.getElementById("weeklyFeedback");

// --- Helpers ---
function getLocalDate(){
  const today = new Date();
  return today.getFullYear() + "-" +
         String(today.getMonth()+1).padStart(2,'0') + "-" +
         String(today.getDate()).padStart(2,'0');
}

function formatTime(sec){
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  return `${h}h ${m}m ${s}s`;
}

function calculateScore(row){
  return (row.prayer?1:0)+(row.mindset?1:0)+(row.prioritize?1:0)+(row.visualize?1:0)+
         (row.exercise?3:0)+(row.tracking?3:0)-row.habitSlips+row.jobHours+row.impactHours*3;
}

// --- Auth ---
onAuthStateChanged(auth, async user=>{
  if(user){
    loginCard.style.display="none"; 
    appDiv.style.display="block";

    // Load dailyRows
    dailyRows={};
    const dailySnap = await getDocs(collection(db,"users",user.uid,"dailyRows"));
    dailySnap.forEach(docSnap => { dailyRows[docSnap.id]=docSnap.data(); });

    // Ensure today exists
    const today = getLocalDate();
    if(!dailyRows[today]){
      const newRow = {date: today, prayer:false, mindset:false, prioritize:false, visualize:false, exercise:false, tracking:false, habitSlips:0, jobHours:0, impactHours:0};
      dailyRows[today] = newRow;
      saveDailyRow(newRow);
    }

    // Load tasks
    const taskSnap = await getDoc(doc(db,"users",user.uid,"meta","tasks"));
    tasks = taskSnap.exists() ? taskSnap.data().tasks || [] : [];
    renderTasks();

    // Load habits
    const habitSnap = await getDoc(doc(db,"users",user.uid,"meta","habits"));
    habits = habitSnap.exists() ? habitSnap.data().habits || [] : [];
    renderHabits();

    // Load timers
    const timerSnap = await getDoc(doc(db,"users",user.uid,"meta","timers"));
    if(timerSnap.exists()){
      jobSeconds = timerSnap.data().jobSeconds || 0;
      impactSeconds = timerSnap.data().impactSeconds || 0;
    }

    renderAllRows();
    renderCharts();
    startTimers();
  } else {
    loginCard.style.display="block"; 
    appDiv.style.display="none";
  }
});

// --- Login / Signup ---
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(e){ loginError.innerText=`Login failed: ${e.message}`; }
});

document.getElementById("signupBtn").addEventListener("click", async ()=>{
  loginError.innerText="";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await createUserWithEmailAndPassword(auth,email,password); alert("Signup successful! You can now login."); }
  catch(e){ loginError.innerText=`Signup failed: ${e.message}`; }
});

document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

// --- Save functions ---
async function saveDailyRow(row){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"dailyRows",row.date),row); }
async function saveTasks(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","tasks"),{tasks}); }
async function saveHabits(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","habits"),{habits}); }
async function saveTimers(){ if(auth.currentUser) await setDoc(doc(db,"users",auth.currentUser.uid,"meta","timers"),{jobSeconds,impactSeconds}); }

// --- Daily Tracker ---
document.getElementById("addDayBtn").addEventListener("click", ()=>{
  const today = getLocalDate();
  if(dailyRows[today]){
    alert("Today's row already exists"); return;
  }
  const row = {date: today, prayer:false, mindset:false, prioritize:false, visualize:false, exercise:false, tracking:false, habitSlips:0, jobHours:0, impactHours:0};
  dailyRows[today]=row;
  saveDailyRow(row);
  renderAllRows();
  renderCharts();
});

function renderRow(row){
  const tbody = document.getElementById("dailyBody");
  const tr = document.createElement("tr");
  tr.id="row_"+row.date;
  const score = calculateScore(row);
  let bg = score>=15?"#d4edda":score>=10?"#fff3cd":"#f8d7da";
  tr.style.backgroundColor=bg;
  tr.innerHTML=`
<td>${row.date}</td>
<td><input type="checkbox" ${row.prayer?'checked':''} onchange="toggleCheck('${row.date}','prayer')"></td>
<td><input type="checkbox" ${row.mindset?'checked':''} onchange="toggleCheck('${row.date}','mindset')"></td>
<td><input type="checkbox" ${row.prioritize?'checked':''} onchange="toggleCheck('${row.date}','prioritize')"></td>
<td><input type="checkbox" ${row.visualize?'checked':''} onchange="toggleCheck('${row.date}','visualize')"></td>
<td><input type="checkbox" ${row.exercise?'checked':''} onchange="toggleCheck('${row.date}','exercise')"></td>
<td><input type="checkbox" ${row.tracking?'checked':''} onchange="toggleCheck('${row.date}','tracking')"></td>
<td id="habitSlips_${row.date}">${row.habitSlips}</td>
<td id="jobHours_${row.date}">${row.jobHours}</td>
<td id="impactHours_${row.date}">${row.impactHours}</td>
<td id="dailyScore_${row.date}">${score}</td>
`;
  tbody.appendChild(tr);
}

function renderAllRows(){
  const tbody = document.getElementById("dailyBody");
  tbody.innerHTML="";
  const dates = Object.keys(dailyRows).sort((a,b)=>new Date(b)-new Date(a));
  const last7 = dates.slice(0,7).reverse();
  last7.forEach(d=>renderRow(dailyRows[d]));

  // Weekly feedback and level/streak
  weeklyPoints = last7.reduce((sum,d)=>sum+calculateScore(dailyRows[d]),0);
  streak = calculateStreak();
  weeklyFeedback.innerText = `Weekly Score: ${weeklyPoints} | Level: ${currentLevel} | Streak: ${streak} weeks`;
}

window.toggleCheck = function(date,field){
  const row = dailyRows[date];
  row[field] = !row[field];
  if(field!=="tracking") row.tracking=true;
  saveDailyRow(row);
  renderAllRows();
  renderCharts();
}

// --- Tasks ---
document.getElementById("addTaskBtn").addEventListener("click",()=>{
  const val = document.getElementById("taskInput").value.trim();
  if(!val) return;
  if(tasks.length>=3) alert("Only top 3 tasks allowed");
  else { tasks.push({text:val,done:false}); document.getElementById("taskInput").value=""; saveTasks(); renderTasks();}
});
document.getElementById("resetTasksBtn").addEventListener("click",()=>{tasks=[]; saveTasks(); renderTasks();});
function renderTasks(){
  const div = document.getElementById("taskList");
  div.innerHTML="";
  tasks.forEach((t,i)=>{
    const p = document.createElement("p");
    p.innerHTML=`<input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${i})"> ${t.text} <button onclick="deleteTask(${i})">X</button>`;
    div.appendChild(p);
  });
}
window.toggleTask = function(i){ tasks[i].done = !tasks[i].done; saveTasks(); renderTasks();}
window.deleteTask = function(i){ tasks.splice(i,1); saveTasks(); renderTasks();}

// --- Habits ---
document.getElementById("addHabitBtn").addEventListener("click",()=>{
  const val = document.getElementById("habitInput").value.trim();
  if(!val) return;
  habits.push({name:val,lastSlip:null});
  document.getElementById("habitInput").value="";
  saveHabits();
  renderHabits();
});
function renderHabits(){
  const div = document.getElementById("habitList");
  div.innerHTML="";
  habits.forEach((h,i)=>{
    const days = h.lastSlip ? Math.floor((new Date()-new Date(h.lastSlip))/(1000*60*60*24)) : 0;
    const p = document.createElement("p");
    p.innerHTML=`${h.name} - Days since last slip: ${days} <button onclick="habitSlip(${i})">Slip</button> <button onclick="deleteHabit(${i})">X</button>`;
    div.appendChild(p);
  });
}
window.habitSlip = function(i){ habits[i].lastSlip=new Date(); saveHabits(); renderHabits();}
window.deleteHabit = function(i){ habits.splice(i,1); saveHabits(); renderHabits();}

// --- Timers ---
document.getElementById("startJobBtn").addEventListener("click",()=>{if(jobInterval) clearInterval(jobInterval); jobInterval=setInterval(()=>{jobSeconds++; document.getElementById("jobTime").innerText=formatTime(jobSeconds); saveTimers();},1000)});
document.getElementById("stopJobBtn").addEventListener("click",()=>{if(jobInterval) clearInterval(jobInterval); jobInterval=null;});
document.getElementById("startImpactBtn").addEventListener("click",()=>{if(impactInterval) clearInterval(impactInterval); impactInterval=setInterval(()=>{impactSeconds++; document.getElementById("impactTime").innerText=formatTime(impactSeconds); saveTimers();},1000)});
document.getElementById("stopImpactBtn").addEventListener("click",()=>{if(impactInterval) clearInterval(impactInterval); impactInterval=null;});
function startTimers(){
  document.getElementById("jobTime").innerText=formatTime(jobSeconds);
  document.getElementById("impactTime").innerText=formatTime(impactSeconds);
}

// --- Charts ---
function renderCharts(){
  const dates = Object.keys(dailyRows).sort((a,b)=>new Date(a)-new Date(b));
  const last7 = dates.slice(-7);
  const scores = last7.map(d=>calculateScore(dailyRows[d]));

  // Daily line chart
  const ctx1=document.getElementById("dailyScoreChart").getContext("2d");
  if(dailyChart) dailyChart.destroy();
  dailyChart = new Chart(ctx1,{type:"line",data:{labels:last7, datasets:[{label:"Daily Score",data:scores, borderColor:"blue", fill:false}]}});

  // Weekly bar chart
  const weeks = [last7.reduce((a,d)=>a+calculateScore(dailyRows[d]),0)];
  const ctx2=document.getElementById("weeklyBarChart").getContext("2d");
  if(weeklyChart) weeklyChart.destroy();
  weeklyChart=new Chart(ctx2,{type:"bar",data:{labels:["Current Week"], datasets:[{label:"Weekly Score",data:weeks,backgroundColor:"orange"}]}});

  // Monthly line chart (simplified for last 4 weeks)
  const ctx3=document.getElementById("monthlyLineChart").getContext("2d");
  if(monthlyChart) monthlyChart.destroy();
  monthlyChart=new Chart(ctx3,{type:"line",data:{labels:["Week1","Week2","Week3","Week4"], datasets:[{label:"Weekly Score",data:weeks.concat([0,0,0]).slice(-4), borderColor:"green", fill:false}]}});

  // Pie chart
  const prayer=Object.values(dailyRows).reduce((a,r)=>a+(r.prayer?1:0),0);
  const mindset=Object.values(dailyRows).reduce((a,r)=>a+(r.mindset?1:0),0);
  const prioritize=Object.values(dailyRows).reduce((a,r)=>a+(r.prioritize?1:0),0);
  const visualize=Object.values(dailyRows).reduce((a,r)=>a+(r.visualize?1:0),0);
  const exercise=Object.values(dailyRows).reduce((a,r)=>a+(r.exercise?3:0),0);
  const tracking=Object.values(dailyRows).reduce((a,r)=>a+(r.tracking?3:0),0);
  const ctx4=document.getElementById("pieChart").getContext("2d");
  if(pieChart) pieChart.destroy();
  pieChart=new Chart(ctx4,{type:"pie",data:{labels:["Prayer","Mindset","Prioritize","Visualize","Exercise","Tracking"],datasets:[{data:[prayer,mindset,prioritize,visualize,exercise,tracking],backgroundColor:["#f39c12","#3498db","#2ecc71","#9b59b6","#e74c3c","#1abc9c"]]}});

}

// --- Level/Streak logic ---
function calculateStreak(){ return 0; /* Placeholder: can add 4-week consecutive points logic */ }

</script>

<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f2f2f2;}
.card{background:white;padding:20px;margin:15px auto;width:90%;max-width:1000px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.card h2{text-align:center;margin-bottom:10px;}
.input-group{text-align:center;margin-bottom:10px;}
input[type="text"], input[type="email"], input[type="password"]{display:block;margin:10px auto;padding:8px;width:80%;max-width:300px;text-align:center;}
button{padding:5px 10px;border:none;border-radius:6px;background:#007bff;color:white;margin:2px;cursor:pointer;}
button:hover{opacity:0.9;}
#logoutBtn{position:absolute;top:10px;right:10px;}
section{margin-bottom:20px;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login-card" class="card">
  <h2>Login / Signup</h2>
  <div class="input-group">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Signup</button>
  </div>
  <p id="loginError" style="color:red;text-align:center"></p>
</div>

<!-- APP -->
<div id="app" style="display:none; position:relative;">
<button id="logoutBtn">Logout</button>

<!-- DAILY TRACKER -->
<section class="card">
<h2>Daily Tracker</h2>
<button id="addDayBtn">Add Today</button>
<p id="weeklyFeedback"></p>
<table border="1" width="100%">
<thead>
<tr>
<th>Date</th><th>Prayer</th><th>Mindset</th><th>Prioritize</th><th>Visualize</th><th>Exercise</th><th>Tracking</th><th>Habit Slips</th><th>Job Hours</th><th>Impact Hours</th><th>Score</th>
</tr>
</thead>
<tbody id="dailyBody"></tbody>
</table>
</section>

<!-- TOP 3 -->
<section class="card">
<h2>Top 3</h2>
<input type="text" id="taskInput" placeholder="Enter task">
<button id="addTaskBtn">Add Task</button>
<button id="resetTasksBtn">Reset</button>
<div id="taskList"></div>
</section>

<!-- HABIT BREAKING -->
<section class="card">
<h2>Habit Breaking</h2>
<input type="text" id="habitInput" placeholder="Enter habit">
<button id="addHabitBtn">Add Habit</button>
<div id="habitList"></div>
</section>

<!-- TIMERS -->
<section class="card">
<h2>Timers</h2>
<p>Job Hours: <span id="jobTime">0h 0m 0s</span> 
<button id="startJobBtn">Start</button> 
<button id="stopJobBtn">Stop</button></p>
<p>Impact Hours: <span id="impactTime">0h 0m 0s</span> 
<button id="startImpactBtn">Start</button> 
<button id="stopImpactBtn">Stop</button></p>
</section>

<!-- CHARTS -->
<section class="card">
<h2>Daily Score Chart</h2>
<canvas id="dailyScoreChart"></canvas>
<h2>Weekly Bar Chart</h2>
<canvas id="weeklyBarChart"></canvas>
<h2>Monthly Line Chart</h2>
<canvas id="monthlyLineChart"></canvas>
<h2>Point Distribution</h2>
<canvas id="pieChart"></canvas>
</section>

</body>
</html>
